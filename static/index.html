<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å¸å®‰åŒå¸ç†è´¢ vs æœŸæƒå–å‡º â€” æ”¶ç›Šå¯¹æ¯”</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#0f1117;--surface:#1a1d27;--border:#2a2d3a;
  --text:#e2e8f0;--text2:#94a3b8;
  --green:#4ade80;--red:#f87171;--yellow:#fbbf24;--purple:#818cf8;
  --blue:#60a5fa;
}
body{
  font-family:'JetBrains Mono',monospace;background:var(--bg);color:var(--text);
  min-height:100vh;padding:0 20px 20px;
}
a{color:var(--purple)}

/* header */
.header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap;gap:12px}
.header h1{font-size:1.2rem;color:var(--green)}
.header .spot{font-size:.95rem;color:var(--text2)}
.header .spot b{color:var(--yellow);font-weight:600}

/* status bar */
.status-bar{
  padding:10px 16px;border-radius:8px;margin-bottom:16px;font-size:.8rem;
  display:flex;align-items:center;gap:8px;
}
.status-bar.ok{background:#16a34a22;border:1px solid #16a34a44;color:var(--green)}
.status-bar.err{background:#dc262622;border:1px solid #dc262644;color:var(--red)}
.status-bar.loading{background:#2563eb22;border:1px solid #2563eb44;color:var(--blue)}
.dot{width:8px;height:8px;border-radius:50%;display:inline-block}
.status-bar.ok .dot{background:var(--green)}
.status-bar.err .dot{background:var(--red)}
.status-bar.loading .dot{background:var(--blue);animation:pulse 1s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}

/* filters */
.filters{
  display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:20px;
}
.filters label{font-size:.75rem;color:var(--text2);margin-right:2px}
.pill-group{display:flex;gap:4px}
.pill{
  padding:6px 14px;border-radius:6px;font-size:.75rem;cursor:pointer;
  border:1px solid var(--border);background:transparent;color:var(--text2);
  font-family:inherit;transition:all .15s;
}
.pill:hover{border-color:var(--purple)}
.pill.active{background:var(--purple);color:#fff;border-color:var(--purple)}
.btn{
  padding:6px 14px;border-radius:6px;font-size:.75rem;cursor:pointer;
  border:1px solid var(--border);background:var(--surface);color:var(--text);
  font-family:inherit;transition:all .15s;
}
.btn:hover{border-color:var(--green);color:var(--green)}
.btn.active{background:var(--green);color:var(--bg);border-color:var(--green)}
.spacer{flex:1}

/* stat cards */
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin-bottom:24px}
.stat-card{
  background:var(--surface);border:1px solid var(--border);border-radius:10px;
  padding:16px 20px;
}
.stat-card .label{font-size:.7rem;color:var(--text2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px}
.stat-card .value{font-size:1.4rem;font-weight:700}
.stat-card .value.green{color:var(--green)}
.stat-card .value.yellow{color:var(--yellow)}
.stat-card .value.purple{color:var(--purple)}
.stat-card .value.blue{color:var(--blue)}

/* charts */
.charts{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:24px}
.chart-box{
  background:var(--surface);border:1px solid var(--border);border-radius:10px;
  padding:16px;
}
.chart-box h3{font-size:.8rem;color:var(--text2);margin-bottom:12px}
@media(max-width:900px){.charts{grid-template-columns:1fr}}

/* table */
.table-wrap{
  background:var(--surface);border:1px solid var(--border);border-radius:10px;
  overflow-x:auto;margin-bottom:24px;
}
table{width:100%;border-collapse:collapse;font-size:.78rem}
th{
  padding:12px 10px;text-align:left;color:var(--text2);font-weight:500;
  border-bottom:1px solid var(--border);cursor:pointer;white-space:nowrap;
  user-select:none;
}
th:hover{color:var(--purple)}
th .arrow{font-size:.65rem;margin-left:3px}
td{padding:10px;border-bottom:1px solid var(--border);white-space:nowrap}
tr:hover{background:#ffffff06}
.tag{
  display:inline-block;padding:2px 8px;border-radius:4px;font-size:.7rem;font-weight:600;
}
.tag.call{background:#818cf822;color:var(--purple)}
.tag.put{background:#60a5fa22;color:var(--blue)}
.tag.low{background:#4ade8022;color:var(--green)}
.tag.mid{background:#fbbf2422;color:var(--yellow)}
.tag.high{background:#f8717122;color:var(--red)}
.tag.liq-high{background:#4ade8022;color:var(--green)}
.tag.liq-mid{background:#fbbf2422;color:var(--yellow)}
.tag.liq-low{background:#f8717122;color:var(--red)}
.tag.liq-none{background:#64748b22;color:#64748b}
.profit{font-weight:600}

/* collapsible */
.collapsible{
  background:var(--surface);border:1px solid var(--border);border-radius:10px;
  margin-bottom:24px;
}
.collapsible summary{
  padding:14px 20px;cursor:pointer;font-size:.8rem;color:var(--text2);
  list-style:none;display:flex;align-items:center;gap:8px;
}
.collapsible summary::before{content:'â–¸';transition:transform .2s}
.collapsible[open] summary::before{transform:rotate(90deg)}
.collapsible .inner{padding:0 20px 16px}
.unmatched-table{width:100%;font-size:.75rem;border-collapse:collapse}
.unmatched-table th,.unmatched-table td{padding:8px 10px;text-align:left;border-bottom:1px solid var(--border)}
.unmatched-table th{color:var(--text2);font-weight:500}

.note{font-size:.7rem;color:var(--text2);text-align:center;padding:20px}

/* position panel */
.pos-section{
  background:var(--surface);border:1px solid var(--border);border-radius:10px;
  margin-bottom:24px;padding:20px;
}
.pos-section h2{font-size:.95rem;color:var(--yellow);margin-bottom:16px;display:flex;align-items:center;gap:8px}
.pos-section h2 .pos-count{
  font-size:.7rem;background:var(--yellow);color:var(--bg);
  padding:2px 8px;border-radius:10px;font-weight:700;
}
.pos-empty{color:var(--text2);font-size:.8rem;padding:20px 0;text-align:center}
.pos-table{width:100%;border-collapse:collapse;font-size:.75rem}
.pos-table th{
  padding:10px 8px;text-align:left;color:var(--text2);font-weight:500;
  border-bottom:1px solid var(--border);white-space:nowrap;font-size:.7rem;
}
.pos-table td{padding:8px;border-bottom:1px solid var(--border);white-space:nowrap}
.pos-table tr:hover{background:#ffffff06}
.signal{display:inline-block;padding:2px 8px;border-radius:4px;font-size:.68rem;font-weight:600}
.signal.strong-close{background:#f8717133;color:var(--red)}
.signal.suggest-close{background:#fbbf2433;color:var(--yellow)}
.signal.hold{background:#4ade8033;color:var(--green)}
.signal.watch{background:#64748b33;color:#94a3b8}
.btn-sm{
  padding:3px 10px;border-radius:4px;font-size:.68rem;cursor:pointer;
  border:1px solid var(--border);background:transparent;color:var(--text2);
  font-family:inherit;transition:all .15s;
}
.btn-sm:hover{border-color:var(--purple);color:var(--purple)}
.btn-sm.danger:hover{border-color:var(--red);color:var(--red)}
.btn-open{
  padding:2px 8px;border-radius:4px;font-size:.66rem;cursor:pointer;
  border:1px solid var(--green);background:transparent;color:var(--green);
  font-family:inherit;transition:all .15s;
}
.btn-open:hover{background:var(--green);color:var(--bg)}

/* modal */
.modal-overlay{
  position:fixed;top:0;left:0;width:100%;height:100%;
  background:rgba(0,0,0,.6);z-index:1000;display:flex;align-items:center;justify-content:center;
}
.modal-overlay.hidden{display:none}
.modal{
  background:var(--surface);border:1px solid var(--border);border-radius:12px;
  padding:24px;width:420px;max-width:95vw;
}
.modal h3{font-size:.9rem;color:var(--green);margin-bottom:16px}
.modal .form-row{margin-bottom:12px}
.modal .form-row label{display:block;font-size:.7rem;color:var(--text2);margin-bottom:4px}
.modal .form-row input{
  width:100%;padding:8px 12px;border-radius:6px;border:1px solid var(--border);
  background:var(--bg);color:var(--text);font-family:inherit;font-size:.8rem;
}
.modal .form-row input:focus{outline:none;border-color:var(--purple)}
.modal .form-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:16px}
.modal .form-actions button{
  padding:8px 20px;border-radius:6px;font-size:.78rem;cursor:pointer;
  font-family:inherit;border:none;transition:all .15s;
}
.modal .btn-cancel{background:var(--border);color:var(--text)}
.modal .btn-cancel:hover{background:#3a3d4a}
.modal .btn-submit{background:var(--green);color:var(--bg);font-weight:600}
.modal .btn-submit:hover{opacity:.85}

/* nav bar */
.nav-bar{
  display:flex;align-items:center;gap:0;
  padding:12px 0;margin-bottom:16px;border-bottom:1px solid var(--border);
}
.nav-link{
  padding:8px 20px;font-size:.8rem;color:var(--text2);
  text-decoration:none;border-radius:6px 6px 0 0;
  border:1px solid transparent;border-bottom:none;
  transition:all .15s;font-family:inherit;
  position:relative;top:1px;
}
.nav-link:hover{color:var(--text)}
.nav-link.active{
  color:var(--green);background:var(--surface);
  border-color:var(--border);
}
</style>
</head>
<body>

<!-- Navigation -->
<nav class="nav-bar">
  <a class="nav-link active" href="/">åŒå¸å¯¹æ¯”</a>
  <a class="nav-link" href="/options">æœŸæƒè¡Œæƒ…</a>
</nav>

<div class="header">
  <h1>å¸å®‰åŒå¸ç†è´¢ vs æœŸæƒå–å‡º</h1>
  <div class="spot">
    <span id="coinLabel">ETH</span>/USDT ç°è´§: <b id="spotPrice">â€”</b>
    &nbsp;Â·&nbsp; <span id="updateTime">â€”</span>
  </div>
</div>

<div id="statusBar" class="status-bar loading">
  <span class="dot"></span> <span id="statusText">æ£€æŸ¥æœåŠ¡çŠ¶æ€â€¦</span>
</div>

<!-- Filters -->
<div class="filters">
  <label>å¸ç§</label>
  <div class="pill-group" id="coinGroup">
    <button class="pill active" data-coin="ETH">ETH</button>
    <button class="pill" data-coin="BTC">BTC</button>
  </div>
  <label>ç±»å‹</label>
  <div class="pill-group" id="typeGroup">
    <button class="pill active" data-type="ALL">å…¨éƒ¨</button>
    <button class="pill" data-type="CALL">CALL</button>
    <button class="pill" data-type="PUT">PUT</button>
  </div>
  <label>æœŸé™</label>
  <div class="pill-group" id="termGroup">
    <button class="pill active" data-min="0" data-max="0">å…¨éƒ¨</button>
    <button class="pill" data-min="0" data-max="3">0-3å¤©</button>
    <button class="pill" data-min="3" data-max="7">3-7å¤©</button>
    <button class="pill" data-min="7" data-max="14">7-14å¤©</button>
    <button class="pill" data-min="14" data-max="30">14-30å¤©</button>
  </div>
  <div class="spacer"></div>
  <button class="btn" id="btnRefresh">âŸ³ åˆ·æ–°</button>
  <button class="btn" id="btnAuto">è‡ªåŠ¨ OFF</button>
</div>

<!-- Stats -->
<div class="stats">
  <div class="stat-card"><div class="label">å¹³å‡æŠ½æˆ</div><div class="value yellow" id="statAvgSpread">â€”</div></div>
  <div class="stat-card"><div class="label">å¹³å‡å¤šèµš APR</div><div class="value green" id="statAvgDiff">â€”</div></div>
  <div class="stat-card"><div class="label">10ä¸‡Uæœ€å¤§å¤šèµš</div><div class="value green" id="statMaxExtra">â€”</div></div>
  <div class="stat-card"><div class="label">åŒ¹é…äº§å“æ•°</div><div class="value purple" id="statCount">â€”</div></div>
  <div class="stat-card"><div class="label">ç°è´§ä»·æ ¼</div><div class="value blue" id="statSpot">â€”</div></div>
</div>

<!-- Charts -->
<div class="charts">
  <div class="chart-box">
    <h3>åŒå¸APR vs æœŸæƒAPR å¯¹æ¯”</h3>
    <canvas id="barChart"></canvas>
  </div>
  <div class="chart-box">
    <h3>åˆ°æœŸå¤©æ•° vs æŠ½æˆæ¯”ä¾‹</h3>
    <canvas id="scatterChart"></canvas>
  </div>
</div>

<!-- Data Table -->
<div class="table-wrap">
  <table id="dataTable">
    <thead>
      <tr>
        <th data-key="type">ç±»å‹ <span class="arrow"></span></th>
        <th data-key="strike">è¡Œæƒä»· <span class="arrow"></span></th>
        <th data-key="expiry">åˆ°æœŸæ—¥ <span class="arrow"></span></th>
        <th data-key="days">å¤©æ•° <span class="arrow"></span></th>
        <th data-key="dualAPR">åŒå¸APR <span class="arrow"></span></th>
        <th data-key="optionAPRNet">æœŸæƒAPR(å‡€) <span class="arrow"></span></th>
        <th data-key="diffAPR">å·®å€¼APR <span class="arrow"></span></th>
        <th data-key="dualProfit">åŒå¸åˆ©æ¶¦ <span class="arrow"></span></th>
        <th data-key="optionProfit">æœŸæƒåˆ©æ¶¦ <span class="arrow"></span></th>
        <th data-key="extraProfit">å¤šèµš <span class="arrow"></span></th>
        <th data-key="optionBid">Bidä»· <span class="arrow"></span></th>
        <th data-key="bidNotional">Bidæ·±åº¦ <span class="arrow"></span></th>
        <th data-key="spreadPct">æŠ½æˆ% <span class="arrow"></span></th>
        <th>æ“ä½œ</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>
</div>

<!-- Position Panel -->
<div class="pos-section" id="posSection">
  <h2>ğŸ“Š æˆ‘çš„æŒä»“ <span class="pos-count" id="posCount">0</span></h2>
  <div id="posContent">
    <div class="pos-empty">æš‚æ— æŒä»“ï¼Œå¯åœ¨ä¸Šæ–¹å¯¹æ¯”è¡¨æ ¼ä¸­ç‚¹å‡»ã€Œå»ºä»“ã€æ·»åŠ </div>
  </div>
</div>

<!-- Position Modal -->
<div class="modal-overlay hidden" id="posModal">
  <div class="modal">
    <h3 id="modalTitle">æ–°å»ºæŒä»“</h3>
    <div class="form-row">
      <label>æœŸæƒåˆçº¦</label>
      <input type="text" id="posSymbol" placeholder="å¦‚ ETH-260327-2000-P">
    </div>
    <div class="form-row">
      <label>å–å‡ºä»·æ ¼ï¼ˆæƒåˆ©é‡‘ï¼‰</label>
      <input type="number" id="posSellPrice" step="any" placeholder="å¦‚ 50.5">
    </div>
    <div class="form-row">
      <label>æ•°é‡ï¼ˆå¸æ•°ï¼‰</label>
      <input type="number" id="posQty" step="any" placeholder="å¦‚ 1">
    </div>
    <div class="form-row">
      <label>å»ºä»“æ—¥æœŸ</label>
      <input type="date" id="posDate">
    </div>
    <div class="form-actions">
      <button class="btn-cancel" onclick="closeModal()">å–æ¶ˆ</button>
      <button class="btn-submit" onclick="savePosition()">ç¡®è®¤å»ºä»“</button>
    </div>
  </div>
</div>

<!-- Unmatched -->
<details class="collapsible" id="unmatchedSection" style="display:none">
  <summary>æœªåŒ¹é…çš„åŒå¸ç†è´¢äº§å“ (<span id="unmatchedCount">0</span>)</summary>
  <div class="inner">
    <table class="unmatched-table">
      <thead>
        <tr><th>ç±»å‹</th><th>æŠ•å…¥</th><th>è¡Œæƒä»·</th><th>åˆ°æœŸæ—¥</th><th>å¤©æ•°</th><th>åŒå¸APR</th><th>æœŸæƒç¬¦å·</th><th>åŸå› </th></tr>
      </thead>
      <tbody id="unmatchedBody"></tbody>
    </table>
  </div>
</details>

<div class="note">
  * æœŸæƒäº¤æ˜“æ‰‹ç»­è´¹å·²æŒ‰ 0.024%ï¼ˆåä¹‰ä»·å€¼ï¼‰è®¡å…¥ï¼›è¡Œæƒè´¹ 0.015% ä»…å®å€¼åˆ°æœŸæ—¶æ”¶å–ï¼Œæœªè®¡å…¥<br>
  * æ•°æ®æ¥æº: å¸å®‰åŒå¸ç†è´¢ API + å¸å®‰æ¬§å¼æœŸæƒ API
</div>

<script>
// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let currentCoin = 'ETH';
let filterType = 'ALL';
let filterDaysMin = 0;
let filterDaysMax = 0;
let sortKey = 'spreadPct';
let sortAsc = false;
let autoRefresh = false;
let autoTimer = null;
let rawData = null;
let allTickers = {};  // symbol -> askPrice æ˜ å°„

// â”€â”€ Chart instances â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let barChart = null;
let scatterChart = null;

const chartDefaults = {
  color: '#94a3b8',
  borderColor: '#2a2d3a',
  font: { family: "'JetBrains Mono', monospace" },
};
Chart.defaults.color = chartDefaults.color;
Chart.defaults.borderColor = chartDefaults.borderColor;
Chart.defaults.font.family = chartDefaults.font.family;

// â”€â”€ DOM refs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const $ = (s) => document.querySelector(s);
const $$ = (s) => document.querySelectorAll(s);

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
checkHealth();
loadData();

// â”€â”€ Coin pills â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
$('#coinGroup').addEventListener('click', (e) => {
  const btn = e.target.closest('.pill');
  if (!btn) return;
  $$('#coinGroup .pill').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  currentCoin = btn.dataset.coin;
  loadData();
});

// â”€â”€ Type pills â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
$('#typeGroup').addEventListener('click', (e) => {
  const btn = e.target.closest('.pill');
  if (!btn) return;
  $$('#typeGroup .pill').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  filterType = btn.dataset.type;
  render();
});

// â”€â”€ Term pills â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
$('#termGroup').addEventListener('click', (e) => {
  const btn = e.target.closest('.pill');
  if (!btn) return;
  $$('#termGroup .pill').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  filterDaysMin = parseInt(btn.dataset.min);
  filterDaysMax = parseInt(btn.dataset.max);
  render();
});

// â”€â”€ Refresh â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
$('#btnRefresh').addEventListener('click', () => loadData());

$('#btnAuto').addEventListener('click', () => {
  autoRefresh = !autoRefresh;
  $('#btnAuto').textContent = autoRefresh ? 'è‡ªåŠ¨ ON' : 'è‡ªåŠ¨ OFF';
  $('#btnAuto').classList.toggle('active', autoRefresh);
  if (autoRefresh) {
    autoTimer = setInterval(() => loadData(), 60000);
  } else {
    clearInterval(autoTimer);
  }
});

// â”€â”€ Table sort â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
$$('#dataTable th').forEach(th => {
  th.addEventListener('click', () => {
    const key = th.dataset.key;
    if (!key) return;
    if (sortKey === key) {
      sortAsc = !sortAsc;
    } else {
      sortKey = key;
      sortAsc = true;
    }
    render();
  });
});

// â”€â”€ API calls â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function checkHealth() {
  try {
    const res = await fetch('/api/health');
    const j = await res.json();
    if (j.apiKeyConfigured) {
      setStatus('ok', 'API Key å·²é…ç½®ï¼ŒæœåŠ¡æ­£å¸¸');
    } else {
      setStatus('err', 'æœªé…ç½® API Keyï¼ŒåŒå¸ç†è´¢æ•°æ®å°†æ— æ³•è·å–');
    }
  } catch (e) {
    setStatus('err', 'æ— æ³•è¿æ¥åç«¯æœåŠ¡: ' + e.message);
  }
}

async function loadData() {
  setStatus('loading', `æ­£åœ¨åŠ è½½ ${currentCoin} æ•°æ®â€¦`);
  try {
    const [compareRes, tickerRes] = await Promise.all([
      fetch(`/api/compare?coin=${currentCoin}`),
      fetch(`/api/options-tickers?coin=${currentCoin}`)
    ]);
    const j = await compareRes.json();
    if (!j.ok) throw new Error(j.error || 'Unknown error');
    rawData = j.data;
    // è§£æ tickers ç”¨äºæŒä»“é¢æ¿ï¼ˆtickers æ˜¯ {symbol: tickerObj} çš„å­—å…¸ï¼‰
    try {
      const tj = await tickerRes.json();
      if (tj.ok && tj.tickers) {
        Object.assign(allTickers, tj.tickers);
      }
    } catch(_) {}
    // å¦‚æœæŒä»“ä¸­æœ‰éå½“å‰å¸ç§çš„åˆçº¦ï¼Œä¹Ÿè·å–å…¶ tickers
    await loadMissingTickers();
    setStatus('ok', `${currentCoin} æ•°æ®åŠ è½½å®Œæˆ Â· ${rawData.results.length} ä¸ªåŒ¹é…äº§å“`);
    render();
    renderPositions();
  } catch (e) {
    setStatus('err', 'åŠ è½½å¤±è´¥: ' + e.message);
  }
}

// â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function render() {
  if (!rawData) return;

  // header
  $('#coinLabel').textContent = rawData.coin;
  $('#spotPrice').textContent = '$' + Number(rawData.spotPrice).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  $('#updateTime').textContent = rawData.timestamp.replace('T', ' ').replace('Z', ' UTC');

  // filter
  let rows = rawData.results.slice();
  if (filterType !== 'ALL') rows = rows.filter(r => r.type === filterType);
  if (filterDaysMax > 0) rows = rows.filter(r => r.days >= filterDaysMin && r.days <= filterDaysMax);

  // sort
  rows.sort((a, b) => {
    let va = a[sortKey], vb = b[sortKey];
    if (typeof va === 'string') { va = va.toLowerCase(); vb = vb.toLowerCase(); }
    if (va < vb) return sortAsc ? -1 : 1;
    if (va > vb) return sortAsc ? 1 : -1;
    return 0;
  });

  // stats (from filtered)
  const spreads = rows.map(r => r.spreadPct);
  const diffs = rows.map(r => r.diffAPR);
  const avg = arr => arr.length ? arr.reduce((a, b) => a + b, 0) / arr.length : 0;

  const extras = rows.map(r => r.extraProfit);
  $('#statAvgSpread').textContent = spreads.length ? avg(spreads).toFixed(1) + '%' : 'â€”';
  $('#statAvgDiff').textContent = diffs.length ? (avg(diffs) * 100).toFixed(2) + '%' : 'â€”';
  $('#statMaxExtra').textContent = extras.length ? '$' + Math.max(...extras).toFixed(0) : 'â€”';
  $('#statCount').textContent = rows.length;
  $('#statSpot').textContent = '$' + Number(rawData.spotPrice).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

  // sort arrows
  $$('#dataTable th').forEach(th => {
    const arrow = th.querySelector('.arrow');
    if (!arrow) return;
    if (th.dataset.key === sortKey) {
      arrow.textContent = sortAsc ? 'â–²' : 'â–¼';
    } else {
      arrow.textContent = '';
    }
  });

  // table
  const tbody = $('#tableBody');
  tbody.innerHTML = rows.map(r => `<tr>
    <td><span class="tag ${r.type.toLowerCase()}">${r.typeLabel}</span></td>
    <td>${fmtStrike(r.strike)}</td>
    <td>${r.expiry}</td>
    <td>${r.daysLabel}</td>
    <td>${(r.dualAPR * 100).toFixed(2)}%</td>
    <td style="color:var(--green)">${(r.optionAPRNet * 100).toFixed(2)}%</td>
    <td style="color:var(--${r.diffAPR >= 0 ? 'green' : 'red'})">${(r.diffAPR * 100).toFixed(2)}%</td>
    <td class="profit" style="color:var(--purple)">$${r.dualProfit.toFixed(0)}</td>
    <td class="profit" style="color:var(--green)">$${r.optionProfit.toFixed(0)}</td>
    <td class="profit" style="color:var(--${r.extraProfit >= 0 ? 'yellow' : 'red'})">$${r.extraProfit.toFixed(0)}</td>
    <td>${r.optionBid.toFixed(2)}</td>
    <td><span class="tag ${liqClass(r.bidNotional)}">${fmtNotional(r.bidNotional)}</span></td>
    <td><span class="tag ${spreadClass(r.spreadPct)}">${r.spreadPct.toFixed(1)}%</span></td>
    <td><button class="btn-open" onclick="openPositionModal('${r.optionSymbol || buildSymbol(r)}', ${r.optionBid})">å»ºä»“</button></td>
  </tr>`).join('');

  // unmatched
  const um = rawData.unmatched || [];
  const umSec = $('#unmatchedSection');
  if (um.length > 0) {
    umSec.style.display = '';
    $('#unmatchedCount').textContent = um.length;
    $('#unmatchedBody').innerHTML = um.map(u => `<tr>
      <td><span class="tag ${u.type.toLowerCase()}">${u.typeLabel}</span></td>
      <td>${u.investCoin}</td>
      <td>${fmtStrike(u.strike)}</td>
      <td>${u.expiry}</td>
      <td>${u.daysLabel}</td>
      <td>${(u.dualAPR * 100).toFixed(2)}%</td>
      <td style="font-size:.7rem;color:var(--text2)">${u.optionSymbol}</td>
      <td style="color:var(--red)">${u.reason}</td>
    </tr>`).join('');
  } else {
    umSec.style.display = 'none';
  }

  // charts
  renderBarChart(rows);
  renderScatterChart(rows);
}

function fmtStrike(v) {
  return Number(v) === Math.floor(Number(v)) ? Number(v).toLocaleString() : Number(v).toLocaleString(undefined, {maximumFractionDigits: 2});
}

function spreadClass(pct) {
  if (pct < 15) return 'low';
  if (pct <= 20) return 'mid';
  return 'high';
}

function liqClass(notional) {
  if (notional >= 50000) return 'liq-high';
  if (notional >= 10000) return 'liq-mid';
  if (notional > 0) return 'liq-low';
  return 'liq-none';
}

function fmtNotional(v) {
  if (v >= 1000000) return '$' + (v / 1000000).toFixed(1) + 'M';
  if (v >= 1000) return '$' + (v / 1000).toFixed(1) + 'K';
  if (v > 0) return '$' + v.toFixed(0);
  return 'â€”';
}

// â”€â”€ Charts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderBarChart(rows) {
  const ctx = $('#barChart');
  if (barChart) barChart.destroy();

  // pick top 20 by spread to keep chart readable
  const display = rows.slice().sort((a, b) => b.spreadPct - a.spreadPct).slice(0, 20);
  const labels = display.map(r => `${r.type[0]}|${fmtStrike(r.strike)}|${r.daysLabel}`);

  barChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [
        {
          label: 'åŒå¸APR',
          data: display.map(r => +(r.dualAPR * 100).toFixed(2)),
          backgroundColor: '#818cf8aa',
          borderColor: '#818cf8',
          borderWidth: 1,
        },
        {
          label: 'æœŸæƒAPR(å‡€)',
          data: display.map(r => +(r.optionAPRNet * 100).toFixed(2)),
          backgroundColor: '#4ade80aa',
          borderColor: '#4ade80',
          borderWidth: 1,
        },
        {
          label: 'æ‰‹ç»­è´¹APR',
          data: display.map(r => +(r.feeAPR * 100).toFixed(2)),
          backgroundColor: '#f8717166',
          borderColor: '#f87171',
          borderWidth: 1,
        },
      ],
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: 'top', labels: { boxWidth: 12, padding: 16 } },
        tooltip: {
          callbacks: {
            label: ctx => ctx.dataset.label + ': ' + ctx.parsed.y.toFixed(2) + '%',
          },
        },
      },
      scales: {
        y: {
          title: { display: true, text: 'APR (%)' },
          grid: { color: '#2a2d3a' },
        },
        x: {
          ticks: { maxRotation: 60, font: { size: 10 } },
          grid: { display: false },
        },
      },
    },
  });
}

function renderScatterChart(rows) {
  const ctx = $('#scatterChart');
  if (scatterChart) scatterChart.destroy();

  const calls = rows.filter(r => r.type === 'CALL').map(r => ({ x: r.days, y: r.spreadPct }));
  const puts = rows.filter(r => r.type === 'PUT').map(r => ({ x: r.days, y: r.spreadPct }));

  scatterChart = new Chart(ctx, {
    type: 'scatter',
    data: {
      datasets: [
        {
          label: 'CALL (é«˜å–)',
          data: calls,
          backgroundColor: '#818cf8cc',
          borderColor: '#818cf8',
          pointRadius: 5,
        },
        {
          label: 'PUT (ä½ä¹°)',
          data: puts,
          backgroundColor: '#60a5facc',
          borderColor: '#60a5fa',
          pointRadius: 5,
        },
      ],
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: 'top', labels: { boxWidth: 12, padding: 16 } },
        tooltip: {
          callbacks: {
            label: ctx => `${ctx.parsed.x.toFixed(1)}D â†’ ${ctx.parsed.y.toFixed(1)}%`,
          },
        },
      },
      scales: {
        x: {
          title: { display: true, text: 'åˆ°æœŸå¤©æ•°' },
          grid: { color: '#2a2d3a' },
        },
        y: {
          title: { display: true, text: 'æŠ½æˆ (%)' },
          grid: { color: '#2a2d3a' },
        },
      },
    },
  });
}

// â”€â”€ Status â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setStatus(type, msg) {
  const bar = $('#statusBar');
  bar.className = 'status-bar ' + type;
  $('#statusText').textContent = msg;
}

// â”€â”€ Position Management â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function getPositions() {
  try { return JSON.parse(localStorage.getItem('positions') || '[]'); }
  catch(_) { return []; }
}

function savePositions(positions) {
  localStorage.setItem('positions', JSON.stringify(positions));
}

// ä»åˆçº¦ç¬¦å·è§£æåˆ°æœŸæ—¥ï¼Œå¦‚ ETH-260327-2000-P â†’ 2026-03-27
function parseExpiryFromSymbol(symbol) {
  const parts = symbol.split('-');
  if (parts.length < 3) return null;
  const dateStr = parts[1]; // YYMMDD
  if (dateStr.length !== 6) return null;
  const yy = dateStr.substring(0, 2);
  const mm = dateStr.substring(2, 4);
  const dd = dateStr.substring(4, 6);
  return new Date(2000 + parseInt(yy), parseInt(mm) - 1, parseInt(dd));
}

// ä»åˆçº¦ç¬¦å·è§£æå¸ç§
function parseCoinFromSymbol(symbol) {
  return symbol.split('-')[0] || '';
}

// æ„å»ºåˆçº¦ç¬¦å·ï¼ˆä»å¯¹æ¯”è¡¨æ ¼è¡Œæ•°æ®ï¼‰
function buildSymbol(r) {
  return r.optionSymbol || `${currentCoin}-${r.expiry.replace(/-/g, '').substring(2)}-${r.strike}-${r.type === 'CALL' ? 'C' : 'P'}`;
}

// åŠ è½½æŒä»“ä¸­ç¼ºå¤±çš„å¸ç§ tickers
async function loadMissingTickers() {
  const positions = getPositions();
  const neededCoins = new Set();
  positions.forEach(p => {
    const coin = parseCoinFromSymbol(p.symbol);
    if (coin && !allTickers[p.symbol]) neededCoins.add(coin);
  });
  for (const coin of neededCoins) {
    try {
      const res = await fetch(`/api/options-tickers?coin=${coin}`);
      const j = await res.json();
      if (j.ok && j.tickers) Object.assign(allTickers, j.tickers);
    } catch(_) {}
  }
}

// æ‰“å¼€å»ºä»“å¼¹çª—
function openPositionModal(symbol, bidPrice) {
  $('#posSymbol').value = symbol || '';
  $('#posSellPrice').value = bidPrice ? Number(bidPrice).toFixed(2) : '';
  $('#posQty').value = '';
  $('#posDate').value = new Date().toISOString().split('T')[0];
  $('#posModal').classList.remove('hidden');
  if (!symbol) $('#posSymbol').focus();
  else $('#posQty').focus();
}

function closeModal() {
  $('#posModal').classList.add('hidden');
}

// ä¿å­˜æŒä»“
function savePosition() {
  const symbol = $('#posSymbol').value.trim().toUpperCase();
  const sellPrice = parseFloat($('#posSellPrice').value);
  const qty = parseFloat($('#posQty').value);
  const date = $('#posDate').value;

  if (!symbol) return alert('è¯·è¾“å…¥æœŸæƒåˆçº¦');
  if (!sellPrice || sellPrice <= 0) return alert('è¯·è¾“å…¥æœ‰æ•ˆçš„å–å‡ºä»·æ ¼');
  if (!qty || qty <= 0) return alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°é‡');
  if (!date) return alert('è¯·é€‰æ‹©å»ºä»“æ—¥æœŸ');

  const positions = getPositions();
  positions.push({
    id: Date.now().toString(),
    symbol,
    sellPrice,
    qty,
    openDate: date,
  });
  savePositions(positions);
  closeModal();
  renderPositions();
}

// åˆ é™¤æŒä»“
function deletePosition(id) {
  if (!confirm('ç¡®å®šåˆ é™¤æ­¤æŒä»“è®°å½•ï¼Ÿ')) return;
  const positions = getPositions().filter(p => p.id !== id);
  savePositions(positions);
  renderPositions();
}

// æ¸²æŸ“æŒä»“é¢æ¿
function renderPositions() {
  const positions = getPositions();
  const countEl = $('#posCount');
  const contentEl = $('#posContent');
  countEl.textContent = positions.length;

  if (positions.length === 0) {
    contentEl.innerHTML = '<div class="pos-empty">æš‚æ— æŒä»“ï¼Œå¯åœ¨ä¸Šæ–¹å¯¹æ¯”è¡¨æ ¼ä¸­ç‚¹å‡»ã€Œå»ºä»“ã€æ·»åŠ </div>';
    return;
  }

  const now = new Date();
  const rows = positions.map(p => {
    const ticker = allTickers[p.symbol];
    const askPrice = ticker ? parseFloat(ticker.askPrice) : null;
    const expiry = parseExpiryFromSymbol(p.symbol);
    const openDate = new Date(p.openDate);

    // å‰©ä½™å¤©æ•°
    const daysLeft = expiry ? Math.max(0, Math.ceil((expiry - now) / 86400000)) : null;
    // å·²æŒæœ‰å¤©æ•°
    const daysHeld = Math.max(1, Math.ceil((now - openDate) / 86400000));

    // è®¡ç®—
    let earnedPct = null, earnedUsd = null, holdApr = null, closeApr = null, signal = '';

    if (askPrice !== null) {
      earnedPct = (p.sellPrice - askPrice) / p.sellPrice * 100;
      earnedUsd = (p.sellPrice - askPrice) * p.qty;

      // æŒæœ‰å¹´åŒ–ï¼šç»§ç»­æŒæœ‰åˆ°æœŸï¼Œå‰©ä½™å¯èµš = askPriceï¼Œå¹´åŒ– = (askPrice/sellPrice) Ã— (365/å‰©ä½™å¤©æ•°)
      if (daysLeft !== null && daysLeft > 0) {
        holdApr = (askPrice / p.sellPrice) * (365 / daysLeft) * 100;
      }

      // å¹³ä»“å¹´åŒ–ï¼šå·²èµšåˆ©æ¶¦ / å–å‡ºä»· Ã— (365 / å·²æŒæœ‰å¤©æ•°)
      if (daysHeld > 0) {
        closeApr = (earnedPct / 100) * (365 / daysHeld) * 100;
      }

      // ä¿¡å·åˆ¤æ–­
      if (earnedPct < 0) {
        signal = '<span class="signal watch">âšª è§‚å¯Ÿ</span>';
      } else if (earnedPct >= 80) {
        signal = '<span class="signal strong-close">ğŸ”´ å¼ºçƒˆå»ºè®®å¹³ä»“</span>';
      } else if (earnedPct >= 50 && daysLeft !== null && daysLeft >= 10) {
        signal = '<span class="signal suggest-close">ğŸŸ¡ å»ºè®®å¹³ä»“å†å¼€</span>';
      } else if (closeApr !== null && holdApr !== null && closeApr > holdApr && earnedPct > 0) {
        signal = '<span class="signal suggest-close">ğŸŸ¡ å¹³ä»“æ›´ä¼˜</span>';
      } else if (daysLeft !== null && daysLeft <= 2 && earnedPct > 0) {
        signal = '<span class="signal hold">ğŸŸ¢ æŒæœ‰åˆ°æœŸ</span>';
      } else {
        signal = '<span class="signal watch">âšª è§‚å¯Ÿ</span>';
      }
    }

    return { ...p, askPrice, expiry, daysLeft, daysHeld, earnedPct, earnedUsd, holdApr, closeApr, signal };
  });

  const fmtPct = v => v !== null ? v.toFixed(1) + '%' : 'â€”';
  const fmtUsd = v => v !== null ? (v >= 0 ? '+' : '') + '$' + v.toFixed(2) : 'â€”';
  const pctColor = v => v === null ? 'var(--text2)' : v >= 0 ? 'var(--green)' : 'var(--red)';
  const aprFmt = v => v !== null ? v.toFixed(1) + '%' : 'â€”';

  contentEl.innerHTML = `
    <div style="overflow-x:auto">
    <table class="pos-table">
      <thead><tr>
        <th>åˆçº¦</th><th>å–å‡ºä»·</th><th>æ•°é‡</th><th>å½“å‰Ask</th>
        <th>å·²èµš%</th><th>å·²èµš$</th><th>å‰©ä½™å¤©æ•°</th>
        <th>æŒæœ‰å¹´åŒ–</th><th>å¹³ä»“å¹´åŒ–</th><th>ä¿¡å·</th><th>æ“ä½œ</th>
      </tr></thead>
      <tbody>${rows.map(r => `<tr>
        <td style="font-size:.7rem">${r.symbol}</td>
        <td>${r.sellPrice.toFixed(2)}</td>
        <td>${r.qty}</td>
        <td>${r.askPrice !== null ? r.askPrice.toFixed(2) : '<span style="color:var(--text2)">â€”</span>'}</td>
        <td style="color:${pctColor(r.earnedPct)}">${fmtPct(r.earnedPct)}</td>
        <td style="color:${pctColor(r.earnedUsd)}">${fmtUsd(r.earnedUsd)}</td>
        <td>${r.daysLeft !== null ? r.daysLeft + 'å¤©' : 'â€”'}</td>
        <td>${aprFmt(r.holdApr)}</td>
        <td>${aprFmt(r.closeApr)}</td>
        <td>${r.signal}</td>
        <td><button class="btn-sm danger" onclick="deletePosition('${r.id}')">åˆ é™¤</button></td>
      </tr>`).join('')}</tbody>
    </table>
    </div>
    <div style="margin-top:12px;text-align:right">
      <button class="btn-sm" onclick="openPositionModal('','')">+ æ‰‹åŠ¨æ·»åŠ </button>
    </div>
  `;
}

// é¡µé¢åŠ è½½æ—¶æ¸²æŸ“æŒä»“
renderPositions();

// ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
$('#posModal').addEventListener('click', function(e) {
  if (e.target === this) closeModal();
});
</script>
</body>
</html>
