<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>币安双币理财 vs 期权卖出 — 收益对比</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#0f1117;--surface:#1a1d27;--border:#2a2d3a;
  --text:#e2e8f0;--text2:#94a3b8;
  --green:#4ade80;--red:#f87171;--yellow:#fbbf24;--purple:#818cf8;
  --blue:#60a5fa;
}
body{
  font-family:'JetBrains Mono',monospace;background:var(--bg);color:var(--text);
  min-height:100vh;padding:20px;
}
a{color:var(--purple)}

/* header */
.header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap;gap:12px}
.header h1{font-size:1.2rem;color:var(--green)}
.header .spot{font-size:.95rem;color:var(--text2)}
.header .spot b{color:var(--yellow);font-weight:600}

/* status bar */
.status-bar{
  padding:10px 16px;border-radius:8px;margin-bottom:16px;font-size:.8rem;
  display:flex;align-items:center;gap:8px;
}
.status-bar.ok{background:#16a34a22;border:1px solid #16a34a44;color:var(--green)}
.status-bar.err{background:#dc262622;border:1px solid #dc262644;color:var(--red)}
.status-bar.loading{background:#2563eb22;border:1px solid #2563eb44;color:var(--blue)}
.dot{width:8px;height:8px;border-radius:50%;display:inline-block}
.status-bar.ok .dot{background:var(--green)}
.status-bar.err .dot{background:var(--red)}
.status-bar.loading .dot{background:var(--blue);animation:pulse 1s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}

/* filters */
.filters{
  display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:20px;
}
.filters label{font-size:.75rem;color:var(--text2);margin-right:2px}
.pill-group{display:flex;gap:4px}
.pill{
  padding:6px 14px;border-radius:6px;font-size:.75rem;cursor:pointer;
  border:1px solid var(--border);background:transparent;color:var(--text2);
  font-family:inherit;transition:all .15s;
}
.pill:hover{border-color:var(--purple)}
.pill.active{background:var(--purple);color:#fff;border-color:var(--purple)}
.btn{
  padding:6px 14px;border-radius:6px;font-size:.75rem;cursor:pointer;
  border:1px solid var(--border);background:var(--surface);color:var(--text);
  font-family:inherit;transition:all .15s;
}
.btn:hover{border-color:var(--green);color:var(--green)}
.btn.active{background:var(--green);color:var(--bg);border-color:var(--green)}
.spacer{flex:1}

/* stat cards */
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin-bottom:24px}
.stat-card{
  background:var(--surface);border:1px solid var(--border);border-radius:10px;
  padding:16px 20px;
}
.stat-card .label{font-size:.7rem;color:var(--text2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px}
.stat-card .value{font-size:1.4rem;font-weight:700}
.stat-card .value.green{color:var(--green)}
.stat-card .value.yellow{color:var(--yellow)}
.stat-card .value.purple{color:var(--purple)}
.stat-card .value.blue{color:var(--blue)}

/* charts */
.charts{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:24px}
.chart-box{
  background:var(--surface);border:1px solid var(--border);border-radius:10px;
  padding:16px;
}
.chart-box h3{font-size:.8rem;color:var(--text2);margin-bottom:12px}
@media(max-width:900px){.charts{grid-template-columns:1fr}}

/* table */
.table-wrap{
  background:var(--surface);border:1px solid var(--border);border-radius:10px;
  overflow-x:auto;margin-bottom:24px;
}
table{width:100%;border-collapse:collapse;font-size:.78rem}
th{
  padding:12px 10px;text-align:left;color:var(--text2);font-weight:500;
  border-bottom:1px solid var(--border);cursor:pointer;white-space:nowrap;
  user-select:none;
}
th:hover{color:var(--purple)}
th .arrow{font-size:.65rem;margin-left:3px}
td{padding:10px;border-bottom:1px solid var(--border);white-space:nowrap}
tr:hover{background:#ffffff06}
.tag{
  display:inline-block;padding:2px 8px;border-radius:4px;font-size:.7rem;font-weight:600;
}
.tag.call{background:#818cf822;color:var(--purple)}
.tag.put{background:#60a5fa22;color:var(--blue)}
.tag.low{background:#4ade8022;color:var(--green)}
.tag.mid{background:#fbbf2422;color:var(--yellow)}
.tag.high{background:#f8717122;color:var(--red)}

/* collapsible */
.collapsible{
  background:var(--surface);border:1px solid var(--border);border-radius:10px;
  margin-bottom:24px;
}
.collapsible summary{
  padding:14px 20px;cursor:pointer;font-size:.8rem;color:var(--text2);
  list-style:none;display:flex;align-items:center;gap:8px;
}
.collapsible summary::before{content:'▸';transition:transform .2s}
.collapsible[open] summary::before{transform:rotate(90deg)}
.collapsible .inner{padding:0 20px 16px}
.unmatched-table{width:100%;font-size:.75rem;border-collapse:collapse}
.unmatched-table th,.unmatched-table td{padding:8px 10px;text-align:left;border-bottom:1px solid var(--border)}
.unmatched-table th{color:var(--text2);font-weight:500}

.note{font-size:.7rem;color:var(--text2);text-align:center;padding:20px}
</style>
</head>
<body>

<div class="header">
  <h1>币安双币理财 vs 期权卖出</h1>
  <div class="spot">
    <span id="coinLabel">ETH</span>/USDT 现货: <b id="spotPrice">—</b>
    &nbsp;·&nbsp; <span id="updateTime">—</span>
  </div>
</div>

<div id="statusBar" class="status-bar loading">
  <span class="dot"></span> <span id="statusText">检查服务状态…</span>
</div>

<!-- Filters -->
<div class="filters">
  <label>币种</label>
  <div class="pill-group" id="coinGroup">
    <button class="pill active" data-coin="ETH">ETH</button>
    <button class="pill" data-coin="BTC">BTC</button>
    <button class="pill" data-coin="SOL">SOL</button>
    <button class="pill" data-coin="BNB">BNB</button>
  </div>
  <label>类型</label>
  <div class="pill-group" id="typeGroup">
    <button class="pill active" data-type="ALL">全部</button>
    <button class="pill" data-type="CALL">CALL</button>
    <button class="pill" data-type="PUT">PUT</button>
  </div>
  <label>期限</label>
  <div class="pill-group" id="termGroup">
    <button class="pill active" data-days="0">全部</button>
    <button class="pill" data-days="3">≤3D</button>
    <button class="pill" data-days="7">≤7D</button>
    <button class="pill" data-days="14">≤14D</button>
    <button class="pill" data-days="30">≤30D</button>
  </div>
  <div class="spacer"></div>
  <button class="btn" id="btnRefresh">⟳ 刷新</button>
  <button class="btn" id="btnAuto">自动 OFF</button>
</div>

<!-- Stats -->
<div class="stats">
  <div class="stat-card"><div class="label">平均抽成</div><div class="value yellow" id="statAvgSpread">—</div></div>
  <div class="stat-card"><div class="label">平均多赚 APR</div><div class="value green" id="statAvgDiff">—</div></div>
  <div class="stat-card"><div class="label">匹配产品数</div><div class="value purple" id="statCount">—</div></div>
  <div class="stat-card"><div class="label">现货价格</div><div class="value blue" id="statSpot">—</div></div>
</div>

<!-- Charts -->
<div class="charts">
  <div class="chart-box">
    <h3>双币APR vs 期权APR 对比</h3>
    <canvas id="barChart"></canvas>
  </div>
  <div class="chart-box">
    <h3>到期天数 vs 抽成比例</h3>
    <canvas id="scatterChart"></canvas>
  </div>
</div>

<!-- Data Table -->
<div class="table-wrap">
  <table id="dataTable">
    <thead>
      <tr>
        <th data-key="type">类型 <span class="arrow"></span></th>
        <th data-key="investCoin">投入 <span class="arrow"></span></th>
        <th data-key="strike">行权价 <span class="arrow"></span></th>
        <th data-key="expiry">到期日 <span class="arrow"></span></th>
        <th data-key="days">天数 <span class="arrow"></span></th>
        <th data-key="dualAPR">双币APR <span class="arrow"></span></th>
        <th data-key="optionBid">期权Bid <span class="arrow"></span></th>
        <th data-key="optionAPR">期权APR(毛) <span class="arrow"></span></th>
        <th data-key="feeAPR">手续费APR <span class="arrow"></span></th>
        <th data-key="optionAPRNet">期权APR(净) <span class="arrow"></span></th>
        <th data-key="diffAPR">差值APR <span class="arrow"></span></th>
        <th data-key="spreadPct">抽成% <span class="arrow"></span></th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>
</div>

<!-- Unmatched -->
<details class="collapsible" id="unmatchedSection" style="display:none">
  <summary>未匹配的双币理财产品 (<span id="unmatchedCount">0</span>)</summary>
  <div class="inner">
    <table class="unmatched-table">
      <thead>
        <tr><th>类型</th><th>投入</th><th>行权价</th><th>到期日</th><th>天数</th><th>双币APR</th><th>期权符号</th><th>原因</th></tr>
      </thead>
      <tbody id="unmatchedBody"></tbody>
    </table>
  </div>
</details>

<div class="note">
  * 期权手续费已按 taker 0.04%（名义价值）计入，差值APR和抽成%基于扣费后的净收益计算<br>
  * 数据来源: 币安双币理财 API + 币安欧式期权 API
</div>

<script>
// ── State ───────────────────────────────────────────────────────────────────
let currentCoin = 'ETH';
let filterType = 'ALL';
let filterDays = 0;
let sortKey = 'spreadPct';
let sortAsc = false;
let autoRefresh = false;
let autoTimer = null;
let rawData = null;

// ── Chart instances ─────────────────────────────────────────────────────────
let barChart = null;
let scatterChart = null;

const chartDefaults = {
  color: '#94a3b8',
  borderColor: '#2a2d3a',
  font: { family: "'JetBrains Mono', monospace" },
};
Chart.defaults.color = chartDefaults.color;
Chart.defaults.borderColor = chartDefaults.borderColor;
Chart.defaults.font.family = chartDefaults.font.family;

// ── DOM refs ────────────────────────────────────────────────────────────────
const $ = (s) => document.querySelector(s);
const $$ = (s) => document.querySelectorAll(s);

// ── Init ────────────────────────────────────────────────────────────────────
checkHealth();
loadData();

// ── Coin pills ──────────────────────────────────────────────────────────────
$('#coinGroup').addEventListener('click', (e) => {
  const btn = e.target.closest('.pill');
  if (!btn) return;
  $$('#coinGroup .pill').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  currentCoin = btn.dataset.coin;
  loadData();
});

// ── Type pills ──────────────────────────────────────────────────────────────
$('#typeGroup').addEventListener('click', (e) => {
  const btn = e.target.closest('.pill');
  if (!btn) return;
  $$('#typeGroup .pill').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  filterType = btn.dataset.type;
  render();
});

// ── Term pills ──────────────────────────────────────────────────────────────
$('#termGroup').addEventListener('click', (e) => {
  const btn = e.target.closest('.pill');
  if (!btn) return;
  $$('#termGroup .pill').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  filterDays = parseInt(btn.dataset.days);
  render();
});

// ── Refresh ─────────────────────────────────────────────────────────────────
$('#btnRefresh').addEventListener('click', () => loadData());

$('#btnAuto').addEventListener('click', () => {
  autoRefresh = !autoRefresh;
  $('#btnAuto').textContent = autoRefresh ? '自动 ON' : '自动 OFF';
  $('#btnAuto').classList.toggle('active', autoRefresh);
  if (autoRefresh) {
    autoTimer = setInterval(() => loadData(), 60000);
  } else {
    clearInterval(autoTimer);
  }
});

// ── Table sort ──────────────────────────────────────────────────────────────
$$('#dataTable th').forEach(th => {
  th.addEventListener('click', () => {
    const key = th.dataset.key;
    if (!key) return;
    if (sortKey === key) {
      sortAsc = !sortAsc;
    } else {
      sortKey = key;
      sortAsc = true;
    }
    render();
  });
});

// ── API calls ───────────────────────────────────────────────────────────────
async function checkHealth() {
  try {
    const res = await fetch('/api/health');
    const j = await res.json();
    if (j.apiKeyConfigured) {
      setStatus('ok', 'API Key 已配置，服务正常');
    } else {
      setStatus('err', '未配置 API Key，双币理财数据将无法获取');
    }
  } catch (e) {
    setStatus('err', '无法连接后端服务: ' + e.message);
  }
}

async function loadData() {
  setStatus('loading', `正在加载 ${currentCoin} 数据…`);
  try {
    const res = await fetch(`/api/compare?coin=${currentCoin}`);
    const j = await res.json();
    if (!j.ok) throw new Error(j.error || 'Unknown error');
    rawData = j.data;
    setStatus('ok', `${currentCoin} 数据加载完成 · ${rawData.results.length} 个匹配产品`);
    render();
  } catch (e) {
    setStatus('err', '加载失败: ' + e.message);
  }
}

// ── Render ───────────────────────────────────────────────────────────────────
function render() {
  if (!rawData) return;

  // header
  $('#coinLabel').textContent = rawData.coin;
  $('#spotPrice').textContent = '$' + Number(rawData.spotPrice).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  $('#updateTime').textContent = rawData.timestamp.replace('T', ' ').replace('Z', ' UTC');

  // filter
  let rows = rawData.results.slice();
  if (filterType !== 'ALL') rows = rows.filter(r => r.type === filterType);
  if (filterDays > 0) rows = rows.filter(r => r.days <= filterDays);

  // sort
  rows.sort((a, b) => {
    let va = a[sortKey], vb = b[sortKey];
    if (typeof va === 'string') { va = va.toLowerCase(); vb = vb.toLowerCase(); }
    if (va < vb) return sortAsc ? -1 : 1;
    if (va > vb) return sortAsc ? 1 : -1;
    return 0;
  });

  // stats (from filtered)
  const spreads = rows.map(r => r.spreadPct);
  const diffs = rows.map(r => r.diffAPR);
  const avg = arr => arr.length ? arr.reduce((a, b) => a + b, 0) / arr.length : 0;

  $('#statAvgSpread').textContent = spreads.length ? avg(spreads).toFixed(1) + '%' : '—';
  $('#statAvgDiff').textContent = diffs.length ? (avg(diffs) * 100).toFixed(2) + '%' : '—';
  $('#statCount').textContent = rows.length;
  $('#statSpot').textContent = '$' + Number(rawData.spotPrice).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

  // sort arrows
  $$('#dataTable th').forEach(th => {
    const arrow = th.querySelector('.arrow');
    if (!arrow) return;
    if (th.dataset.key === sortKey) {
      arrow.textContent = sortAsc ? '▲' : '▼';
    } else {
      arrow.textContent = '';
    }
  });

  // table
  const tbody = $('#tableBody');
  tbody.innerHTML = rows.map(r => `<tr>
    <td><span class="tag ${r.type.toLowerCase()}">${r.typeLabel}</span></td>
    <td>${r.investCoin}</td>
    <td>${fmtStrike(r.strike)}</td>
    <td>${r.expiry}</td>
    <td>${r.daysLabel}</td>
    <td>${(r.dualAPR * 100).toFixed(2)}%</td>
    <td>${r.optionBid.toFixed(2)}</td>
    <td>${(r.optionAPR * 100).toFixed(2)}%</td>
    <td style="color:var(--red)">${(r.feeAPR * 100).toFixed(2)}%</td>
    <td style="color:var(--green)">${(r.optionAPRNet * 100).toFixed(2)}%</td>
    <td class="${r.diffAPR >= 0 ? 'green' : 'red'}" style="color:var(--${r.diffAPR >= 0 ? 'green' : 'red'})">${(r.diffAPR * 100).toFixed(2)}%</td>
    <td><span class="tag ${spreadClass(r.spreadPct)}">${r.spreadPct.toFixed(1)}%</span></td>
  </tr>`).join('');

  // unmatched
  const um = rawData.unmatched || [];
  const umSec = $('#unmatchedSection');
  if (um.length > 0) {
    umSec.style.display = '';
    $('#unmatchedCount').textContent = um.length;
    $('#unmatchedBody').innerHTML = um.map(u => `<tr>
      <td><span class="tag ${u.type.toLowerCase()}">${u.typeLabel}</span></td>
      <td>${u.investCoin}</td>
      <td>${fmtStrike(u.strike)}</td>
      <td>${u.expiry}</td>
      <td>${u.daysLabel}</td>
      <td>${(u.dualAPR * 100).toFixed(2)}%</td>
      <td style="font-size:.7rem;color:var(--text2)">${u.optionSymbol}</td>
      <td style="color:var(--red)">${u.reason}</td>
    </tr>`).join('');
  } else {
    umSec.style.display = 'none';
  }

  // charts
  renderBarChart(rows);
  renderScatterChart(rows);
}

function fmtStrike(v) {
  return Number(v) === Math.floor(Number(v)) ? Number(v).toLocaleString() : Number(v).toLocaleString(undefined, {maximumFractionDigits: 2});
}

function spreadClass(pct) {
  if (pct < 15) return 'low';
  if (pct <= 20) return 'mid';
  return 'high';
}

// ── Charts ──────────────────────────────────────────────────────────────────
function renderBarChart(rows) {
  const ctx = $('#barChart');
  if (barChart) barChart.destroy();

  // pick top 20 by spread to keep chart readable
  const display = rows.slice().sort((a, b) => b.spreadPct - a.spreadPct).slice(0, 20);
  const labels = display.map(r => `${r.type[0]}|${fmtStrike(r.strike)}|${r.daysLabel}`);

  barChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [
        {
          label: '双币APR',
          data: display.map(r => +(r.dualAPR * 100).toFixed(2)),
          backgroundColor: '#818cf8aa',
          borderColor: '#818cf8',
          borderWidth: 1,
        },
        {
          label: '期权APR(净)',
          data: display.map(r => +(r.optionAPRNet * 100).toFixed(2)),
          backgroundColor: '#4ade80aa',
          borderColor: '#4ade80',
          borderWidth: 1,
        },
        {
          label: '手续费APR',
          data: display.map(r => +(r.feeAPR * 100).toFixed(2)),
          backgroundColor: '#f8717166',
          borderColor: '#f87171',
          borderWidth: 1,
        },
      ],
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: 'top', labels: { boxWidth: 12, padding: 16 } },
        tooltip: {
          callbacks: {
            label: ctx => ctx.dataset.label + ': ' + ctx.parsed.y.toFixed(2) + '%',
          },
        },
      },
      scales: {
        y: {
          title: { display: true, text: 'APR (%)' },
          grid: { color: '#2a2d3a' },
        },
        x: {
          ticks: { maxRotation: 60, font: { size: 10 } },
          grid: { display: false },
        },
      },
    },
  });
}

function renderScatterChart(rows) {
  const ctx = $('#scatterChart');
  if (scatterChart) scatterChart.destroy();

  const calls = rows.filter(r => r.type === 'CALL').map(r => ({ x: r.days, y: r.spreadPct }));
  const puts = rows.filter(r => r.type === 'PUT').map(r => ({ x: r.days, y: r.spreadPct }));

  scatterChart = new Chart(ctx, {
    type: 'scatter',
    data: {
      datasets: [
        {
          label: 'CALL (高卖)',
          data: calls,
          backgroundColor: '#818cf8cc',
          borderColor: '#818cf8',
          pointRadius: 5,
        },
        {
          label: 'PUT (低买)',
          data: puts,
          backgroundColor: '#60a5facc',
          borderColor: '#60a5fa',
          pointRadius: 5,
        },
      ],
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: 'top', labels: { boxWidth: 12, padding: 16 } },
        tooltip: {
          callbacks: {
            label: ctx => `${ctx.parsed.x.toFixed(1)}D → ${ctx.parsed.y.toFixed(1)}%`,
          },
        },
      },
      scales: {
        x: {
          title: { display: true, text: '到期天数' },
          grid: { color: '#2a2d3a' },
        },
        y: {
          title: { display: true, text: '抽成 (%)' },
          grid: { color: '#2a2d3a' },
        },
      },
    },
  });
}

// ── Status ──────────────────────────────────────────────────────────────────
function setStatus(type, msg) {
  const bar = $('#statusBar');
  bar.className = 'status-bar ' + type;
  $('#statusText').textContent = msg;
}
</script>
</body>
</html>
