<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>期权行情 — 全部 BTC/ETH 期权</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#0f1117;--surface:#1a1d27;--border:#2a2d3a;
  --text:#e2e8f0;--text2:#94a3b8;
  --green:#4ade80;--red:#f87171;--yellow:#fbbf24;--purple:#818cf8;
  --blue:#60a5fa;
}
body{
  font-family:'JetBrains Mono',monospace;background:var(--bg);color:var(--text);
  min-height:100vh;padding:0 20px 20px;
}
a{color:var(--purple);text-decoration:none}

/* nav bar */
.nav-bar{
  display:flex;align-items:center;gap:0;
  padding:12px 0;margin-bottom:16px;border-bottom:1px solid var(--border);
}
.nav-link{
  padding:8px 20px;font-size:.8rem;color:var(--text2);
  text-decoration:none;border-radius:6px 6px 0 0;
  border:1px solid transparent;border-bottom:none;
  transition:all .15s;font-family:inherit;
  position:relative;top:1px;
}
.nav-link:hover{color:var(--text)}
.nav-link.active{
  color:var(--green);background:var(--surface);
  border-color:var(--border);
}

/* header */
.header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap;gap:12px}
.header h1{font-size:1.2rem;color:var(--green)}
.header .spot{font-size:.95rem;color:var(--text2)}
.header .spot b{color:var(--yellow);font-weight:600}

/* status bar */
.status-bar{
  padding:10px 16px;border-radius:8px;margin-bottom:16px;font-size:.8rem;
  display:flex;align-items:center;gap:8px;
}
.status-bar.ok{background:#16a34a22;border:1px solid #16a34a44;color:var(--green)}
.status-bar.err{background:#dc262622;border:1px solid #dc262644;color:var(--red)}
.status-bar.loading{background:#2563eb22;border:1px solid #2563eb44;color:var(--blue)}
.dot{width:8px;height:8px;border-radius:50%;display:inline-block}
.status-bar.ok .dot{background:var(--green)}
.status-bar.err .dot{background:var(--red)}
.status-bar.loading .dot{background:var(--blue);animation:pulse 1s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}

/* filters */
.filters{
  display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:20px;
}
.filters label{font-size:.75rem;color:var(--text2);margin-right:2px}
.pill-group{display:flex;gap:4px}
.pill{
  padding:6px 14px;border-radius:6px;font-size:.75rem;cursor:pointer;
  border:1px solid var(--border);background:transparent;color:var(--text2);
  font-family:inherit;transition:all .15s;
}
.pill:hover{border-color:var(--purple)}
.pill.active{background:var(--purple);color:#fff;border-color:var(--purple)}
.btn{
  padding:6px 14px;border-radius:6px;font-size:.75rem;cursor:pointer;
  border:1px solid var(--border);background:var(--surface);color:var(--text);
  font-family:inherit;transition:all .15s;
}
.btn:hover{border-color:var(--green);color:var(--green)}
.btn.active{background:var(--green);color:var(--bg);border-color:var(--green)}
.spacer{flex:1}

/* stat cards */
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-bottom:24px}
.stat-card{
  background:var(--surface);border:1px solid var(--border);border-radius:10px;
  padding:16px 20px;
}
.stat-card .label{font-size:.7rem;color:var(--text2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px}
.stat-card .value{font-size:1.4rem;font-weight:700}
.stat-card .value.green{color:var(--green)}
.stat-card .value.yellow{color:var(--yellow)}
.stat-card .value.purple{color:var(--purple)}
.stat-card .value.blue{color:var(--blue)}

/* table */
.table-wrap{
  background:var(--surface);border:1px solid var(--border);border-radius:10px;
  overflow-x:auto;margin-bottom:24px;
}
table{width:100%;border-collapse:collapse;font-size:.78rem}
th{
  padding:12px 10px;text-align:left;color:var(--text2);font-weight:500;
  border-bottom:1px solid var(--border);cursor:pointer;white-space:nowrap;
  user-select:none;
}
th:hover{color:var(--purple)}
th .arrow{font-size:.65rem;margin-left:3px}
td{padding:10px;border-bottom:1px solid var(--border);white-space:nowrap}
tr:hover{background:#ffffff06}
.tag{
  display:inline-block;padding:2px 8px;border-radius:4px;font-size:.7rem;font-weight:600;
}
.tag.call{background:#818cf822;color:var(--purple)}
.tag.put{background:#60a5fa22;color:var(--blue)}
.tag.otm{background:#4ade8022;color:var(--green)}
.tag.itm{background:#f8717122;color:var(--red)}
.tag.atm{background:#fbbf2422;color:var(--yellow)}

.note{font-size:.7rem;color:var(--text2);text-align:center;padding:20px}

/* position panel */
.pos-section{
  background:var(--surface);border:1px solid var(--border);border-radius:10px;
  margin-bottom:24px;padding:20px;
}
.pos-section h2{font-size:.95rem;color:var(--yellow);margin-bottom:16px;display:flex;align-items:center;gap:8px}
.pos-section h2 .pos-count{
  font-size:.7rem;background:var(--yellow);color:var(--bg);
  padding:2px 8px;border-radius:10px;font-weight:700;
}
.pos-empty{color:var(--text2);font-size:.8rem;padding:20px 0;text-align:center}
.pos-table{width:100%;border-collapse:collapse;font-size:.75rem}
.pos-table th{
  padding:10px 8px;text-align:left;color:var(--text2);font-weight:500;
  border-bottom:1px solid var(--border);white-space:nowrap;font-size:.7rem;
}
.pos-table td{padding:8px;border-bottom:1px solid var(--border);white-space:nowrap}
.pos-table tr:hover{background:#ffffff06}
.signal{display:inline-block;padding:2px 8px;border-radius:4px;font-size:.68rem;font-weight:600}
.signal.strong-close{background:#f8717133;color:var(--red)}
.signal.suggest-close{background:#fbbf2433;color:var(--yellow)}
.signal.hold{background:#4ade8033;color:var(--green)}
.signal.watch{background:#64748b33;color:#94a3b8}
.btn-sm{
  padding:3px 10px;border-radius:4px;font-size:.68rem;cursor:pointer;
  border:1px solid var(--border);background:transparent;color:var(--text2);
  font-family:inherit;transition:all .15s;
}
.btn-sm:hover{border-color:var(--purple);color:var(--purple)}
.btn-sm.danger:hover{border-color:var(--red);color:var(--red)}
.btn-open{
  padding:2px 8px;border-radius:4px;font-size:.66rem;cursor:pointer;
  border:1px solid var(--green);background:transparent;color:var(--green);
  font-family:inherit;transition:all .15s;
}
.btn-open:hover{background:var(--green);color:var(--bg)}

/* modal */
.modal-overlay{
  position:fixed;top:0;left:0;width:100%;height:100%;
  background:rgba(0,0,0,.6);z-index:1000;display:flex;align-items:center;justify-content:center;
}
.modal-overlay.hidden{display:none}
.modal{
  background:var(--surface);border:1px solid var(--border);border-radius:12px;
  padding:24px;width:420px;max-width:95vw;
}
.modal h3{font-size:.9rem;color:var(--green);margin-bottom:16px}
.modal .form-row{margin-bottom:12px}
.modal .form-row label{display:block;font-size:.7rem;color:var(--text2);margin-bottom:4px}
.modal .form-row input{
  width:100%;padding:8px 12px;border-radius:6px;border:1px solid var(--border);
  background:var(--bg);color:var(--text);font-family:inherit;font-size:.8rem;
}
.modal .form-row input:focus{outline:none;border-color:var(--purple)}
.modal .form-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:16px}
.modal .form-actions button{
  padding:8px 20px;border-radius:6px;font-size:.78rem;cursor:pointer;
  font-family:inherit;border:none;transition:all .15s;
}
.modal .btn-cancel{background:var(--border);color:var(--text)}
.modal .btn-cancel:hover{background:#3a3d4a}
.modal .btn-submit{background:var(--green);color:var(--bg);font-weight:600}
.modal .btn-submit:hover{opacity:.85}
</style>
</head>
<body>

<!-- Navigation -->
<nav class="nav-bar">
  <a class="nav-link" href="/">双币对比</a>
  <a class="nav-link active" href="/options">期权行情</a>
</nav>

<div class="header">
  <h1>期权行情</h1>
  <div class="spot">
    <span id="coinLabel">ETH</span>/USDT 现货: <b id="spotPrice">—</b>
    &nbsp;·&nbsp; <span id="updateTime">—</span>
  </div>
</div>

<div id="statusBar" class="status-bar loading">
  <span class="dot"></span> <span id="statusText">检查服务状态…</span>
</div>

<!-- Filters -->
<div class="filters">
  <label>币种</label>
  <div class="pill-group" id="coinGroup">
    <button class="pill active" data-coin="ETH">ETH</button>
    <button class="pill" data-coin="BTC">BTC</button>
  </div>
  <label>类型</label>
  <div class="pill-group" id="typeGroup">
    <button class="pill active" data-type="ALL">全部</button>
    <button class="pill" data-type="CALL">CALL</button>
    <button class="pill" data-type="PUT">PUT</button>
  </div>
  <label>期限</label>
  <div class="pill-group" id="termGroup">
    <button class="pill active" data-days="0">全部</button>
    <button class="pill" data-days="3">≤3天</button>
    <button class="pill" data-days="7">≤7天</button>
    <button class="pill" data-days="14">≤14天</button>
    <button class="pill" data-days="30">≤30天</button>
    <button class="pill" data-days="90">≤90天</button>
  </div>
  <label>价值状态</label>
  <div class="pill-group" id="moneyGroup">
    <button class="pill active" data-money="ALL">全部</button>
    <button class="pill" data-money="OTM">虚值OTM</button>
    <button class="pill" data-money="ITM">实值ITM</button>
  </div>
  <div class="spacer"></div>
  <button class="btn" id="btnRefresh">⟳ 刷新</button>
  <button class="btn" id="btnAuto">自动 OFF</button>
</div>

<!-- Stats -->
<div class="stats">
  <div class="stat-card"><div class="label">合约总数</div><div class="value purple" id="statTotal">—</div></div>
  <div class="stat-card"><div class="label">CALL 数</div><div class="value purple" id="statCall">—</div></div>
  <div class="stat-card"><div class="label">PUT 数</div><div class="value blue" id="statPut">—</div></div>
  <div class="stat-card"><div class="label">最近到期</div><div class="value yellow" id="statNearest">—</div></div>
  <div class="stat-card"><div class="label">现货价格</div><div class="value green" id="statSpot">—</div></div>
</div>

<!-- Data Table -->
<div class="table-wrap">
  <table id="dataTable">
    <thead>
      <tr>
        <th data-key="type">类型 <span class="arrow"></span></th>
        <th data-key="strike">行权价 <span class="arrow"></span></th>
        <th data-key="expiryStr">到期日 <span class="arrow"></span></th>
        <th data-key="daysLeft">天数 <span class="arrow"></span></th>
        <th data-key="moneyness">距离% <span class="arrow"></span></th>
        <th data-key="bid">Bid <span class="arrow"></span></th>
        <th data-key="ask">Ask <span class="arrow"></span></th>
        <th data-key="lastPrice">最新价 <span class="arrow"></span></th>
        <th data-key="volume">24h量 <span class="arrow"></span></th>
        <th data-key="aprNet">卖出APR <span class="arrow"></span></th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>
</div>

<!-- Position Panel -->
<div class="pos-section" id="posSection">
  <h2>我的持仓 <span class="pos-count" id="posCount">0</span></h2>
  <div id="posContent">
    <div class="pos-empty">暂无持仓，可在上方表格中点击「建仓」添加</div>
  </div>
</div>

<!-- Position Modal -->
<div class="modal-overlay hidden" id="posModal">
  <div class="modal">
    <h3 id="modalTitle">新建持仓</h3>
    <div class="form-row">
      <label>期权合约</label>
      <input type="text" id="posSymbol" placeholder="如 ETH-260327-2000-P">
    </div>
    <div class="form-row">
      <label>卖出价格（权利金）</label>
      <input type="number" id="posSellPrice" step="any" placeholder="如 50.5">
    </div>
    <div class="form-row">
      <label>数量（币数）</label>
      <input type="number" id="posQty" step="any" placeholder="如 1">
    </div>
    <div class="form-row">
      <label>建仓日期</label>
      <input type="date" id="posDate">
    </div>
    <div class="form-actions">
      <button class="btn-cancel" onclick="closeModal()">取消</button>
      <button class="btn-submit" onclick="savePosition()">确认建仓</button>
    </div>
  </div>
</div>

<div class="note">
  * 期权交易手续费已按 0.024%（名义价值）计入 APR 计算<br>
  * 数据来源: 币安欧式期权 API (eapi/v1/ticker)
</div>

<script>
// ── State ───────────────────────────────────────────────────────────────────
let currentCoin = 'ETH';
let filterType = 'ALL';
let filterDays = 0;
let filterMoney = 'ALL';
let sortKey = 'aprNet';
let sortAsc = false;
let autoRefresh = false;
let autoTimer = null;
let spotPrice = 0;
let parsedOptions = [];
let allTickers = {};

const $ = (s) => document.querySelector(s);
const $$ = (s) => document.querySelectorAll(s);

// ── Init ────────────────────────────────────────────────────────────────────
checkHealth();
loadData();

// ── Coin pills ──────────────────────────────────────────────────────────────
$('#coinGroup').addEventListener('click', (e) => {
  const btn = e.target.closest('.pill');
  if (!btn) return;
  $$('#coinGroup .pill').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  currentCoin = btn.dataset.coin;
  loadData();
});

// ── Type pills ──────────────────────────────────────────────────────────────
$('#typeGroup').addEventListener('click', (e) => {
  const btn = e.target.closest('.pill');
  if (!btn) return;
  $$('#typeGroup .pill').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  filterType = btn.dataset.type;
  render();
});

// ── Term pills ──────────────────────────────────────────────────────────────
$('#termGroup').addEventListener('click', (e) => {
  const btn = e.target.closest('.pill');
  if (!btn) return;
  $$('#termGroup .pill').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  filterDays = parseInt(btn.dataset.days);
  render();
});

// ── Money pills ─────────────────────────────────────────────────────────────
$('#moneyGroup').addEventListener('click', (e) => {
  const btn = e.target.closest('.pill');
  if (!btn) return;
  $$('#moneyGroup .pill').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  filterMoney = btn.dataset.money;
  render();
});

// ── Refresh ─────────────────────────────────────────────────────────────────
$('#btnRefresh').addEventListener('click', () => loadData());

$('#btnAuto').addEventListener('click', () => {
  autoRefresh = !autoRefresh;
  $('#btnAuto').textContent = autoRefresh ? '自动 ON' : '自动 OFF';
  $('#btnAuto').classList.toggle('active', autoRefresh);
  if (autoRefresh) {
    autoTimer = setInterval(() => loadData(), 60000);
  } else {
    clearInterval(autoTimer);
  }
});

// ── Table sort ──────────────────────────────────────────────────────────────
$$('#dataTable th').forEach(th => {
  th.addEventListener('click', () => {
    const key = th.dataset.key;
    if (!key) return;
    if (sortKey === key) {
      sortAsc = !sortAsc;
    } else {
      sortKey = key;
      sortAsc = key === 'expiryStr' || key === 'type';
    }
    render();
  });
});

// ── API calls ───────────────────────────────────────────────────────────────
async function checkHealth() {
  try {
    const res = await fetch('/api/health');
    const j = await res.json();
    setStatus('ok', '服务正常');
  } catch (e) {
    setStatus('err', '无法连接后端服务: ' + e.message);
  }
}

async function loadData() {
  setStatus('loading', `正在加载 ${currentCoin} 期权数据…`);
  try {
    const [tickerRes, spotRes] = await Promise.all([
      fetch(`/api/options-tickers?coin=${currentCoin}`),
      fetch(`/api/spot-price?coin=${currentCoin}`)
    ]);

    const tj = await tickerRes.json();
    if (!tj.ok) throw new Error(tj.error || 'Ticker error');

    const sj = await spotRes.json();
    if (!sj.ok) throw new Error(sj.error || 'Spot error');

    spotPrice = sj.price;
    const tickers = tj.tickers;
    Object.assign(allTickers, tickers);

    // 解析所有期权
    parsedOptions = [];
    for (const [symbol, t] of Object.entries(tickers)) {
      const parsed = parseSymbol(symbol);
      if (!parsed) continue;

      const bid = parseFloat(t.bidPrice) || 0;
      const ask = parseFloat(t.askPrice) || 0;
      const lastPrice = parseFloat(t.lastPrice) || 0;
      const volume = parseFloat(t.volume) || 0;

      // 距离%（moneyness）
      let moneyness = 0;
      if (parsed.type === 'CALL') {
        moneyness = ((parsed.strike - spotPrice) / spotPrice) * 100;
      } else {
        moneyness = ((spotPrice - parsed.strike) / spotPrice) * 100;
      }
      // 正 = OTM，负 = ITM
      const isOTM = moneyness > 0;

      // APR 计算
      const fee = spotPrice * 0.00024;
      const netBid = bid - fee;
      let aprNet = 0;
      if (bid > 0 && parsed.daysLeft > 0) {
        if (parsed.type === 'PUT') {
          aprNet = (netBid / parsed.strike) * (365 / parsed.daysLeft);
        } else {
          aprNet = (netBid / spotPrice) * (365 / parsed.daysLeft);
        }
      }

      parsedOptions.push({
        symbol,
        type: parsed.type,
        strike: parsed.strike,
        expiryStr: parsed.expiryStr,
        daysLeft: parsed.daysLeft,
        moneyness: Math.round(moneyness * 100) / 100,
        isOTM,
        bid,
        ask,
        lastPrice,
        volume,
        aprNet: Math.round(aprNet * 10000) / 10000,
      });
    }

    // 加载持仓中缺失的币种 tickers
    await loadMissingTickers();

    const now = new Date();
    const timeStr = now.toISOString().replace('T', ' ').replace(/\.\d+Z/, ' UTC');
    setStatus('ok', `${currentCoin} 期权数据加载完成 · ${parsedOptions.length} 个合约`);
    $('#updateTime').textContent = timeStr;
    render();
    renderPositions();
  } catch (e) {
    setStatus('err', '加载失败: ' + e.message);
  }
}

// ── Symbol 解析 ─────────────────────────────────────────────────────────────
function parseSymbol(symbol) {
  // 格式: ETH-260327-2000-P 或 BTC-260328-90000-C
  const parts = symbol.split('-');
  if (parts.length !== 4) return null;
  const dateStr = parts[1]; // YYMMDD
  if (dateStr.length !== 6) return null;
  const yy = parseInt(dateStr.substring(0, 2));
  const mm = parseInt(dateStr.substring(2, 4));
  const dd = parseInt(dateStr.substring(4, 6));
  const expiryDate = new Date(Date.UTC(2000 + yy, mm - 1, dd, 8, 0, 0)); // 08:00 UTC 到期
  const now = new Date();
  const daysLeft = Math.max(0.01, (expiryDate - now) / 86400000);

  return {
    coin: parts[0],
    type: parts[3] === 'C' ? 'CALL' : 'PUT',
    strike: parseFloat(parts[2]),
    expiryStr: `${2000 + yy}-${String(mm).padStart(2, '0')}-${String(dd).padStart(2, '0')}`,
    daysLeft: Math.round(daysLeft * 100) / 100,
  };
}

// ── Render ───────────────────────────────────────────────────────────────────
function render() {
  // header
  $('#coinLabel').textContent = currentCoin;
  $('#spotPrice').textContent = '$' + Number(spotPrice).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

  // filter
  let rows = parsedOptions.slice();
  if (filterType !== 'ALL') rows = rows.filter(r => r.type === filterType);
  if (filterDays > 0) rows = rows.filter(r => r.daysLeft <= filterDays);
  if (filterMoney === 'OTM') rows = rows.filter(r => r.isOTM);
  else if (filterMoney === 'ITM') rows = rows.filter(r => !r.isOTM);

  // sort
  rows.sort((a, b) => {
    let va = a[sortKey], vb = b[sortKey];
    if (typeof va === 'string') { va = va.toLowerCase(); vb = vb.toLowerCase(); }
    if (va < vb) return sortAsc ? -1 : 1;
    if (va > vb) return sortAsc ? 1 : -1;
    return 0;
  });

  // stats (from filtered)
  const calls = rows.filter(r => r.type === 'CALL');
  const puts = rows.filter(r => r.type === 'PUT');
  $('#statTotal').textContent = rows.length;
  $('#statCall').textContent = calls.length;
  $('#statPut').textContent = puts.length;
  $('#statSpot').textContent = '$' + Number(spotPrice).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

  // 最近到期
  if (rows.length > 0) {
    const nearest = rows.reduce((a, b) => a.daysLeft < b.daysLeft ? a : b);
    $('#statNearest').textContent = daysLabel(nearest.daysLeft);
  } else {
    $('#statNearest').textContent = '—';
  }

  // sort arrows
  $$('#dataTable th').forEach(th => {
    const arrow = th.querySelector('.arrow');
    if (!arrow) return;
    if (th.dataset.key === sortKey) {
      arrow.textContent = sortAsc ? '▲' : '▼';
    } else {
      arrow.textContent = '';
    }
  });

  // table
  const tbody = $('#tableBody');
  tbody.innerHTML = rows.map(r => `<tr>
    <td><span class="tag ${r.type === 'CALL' ? 'call' : 'put'}">${r.type}</span></td>
    <td>${fmtStrike(r.strike)}</td>
    <td>${r.expiryStr}</td>
    <td>${daysLabel(r.daysLeft)}</td>
    <td><span class="tag ${r.isOTM ? 'otm' : 'itm'}">${r.isOTM ? 'OTM' : 'ITM'} ${Math.abs(r.moneyness).toFixed(1)}%</span></td>
    <td>${r.bid > 0 ? r.bid.toFixed(2) : '<span style="color:var(--text2)">—</span>'}</td>
    <td>${r.ask > 0 ? r.ask.toFixed(2) : '<span style="color:var(--text2)">—</span>'}</td>
    <td>${r.lastPrice > 0 ? r.lastPrice.toFixed(2) : '<span style="color:var(--text2)">—</span>'}</td>
    <td>${r.volume > 0 ? fmtVolume(r.volume) : '<span style="color:var(--text2)">—</span>'}</td>
    <td style="color:${r.aprNet > 0 ? 'var(--green)' : 'var(--text2)'}">${r.aprNet > 0 ? (r.aprNet * 100).toFixed(2) + '%' : '—'}</td>
    <td><button class="btn-open" onclick="openPositionModal('${r.symbol}', ${r.bid})">建仓</button></td>
  </tr>`).join('');
}

function fmtStrike(v) {
  return Number(v) === Math.floor(Number(v))
    ? Number(v).toLocaleString()
    : Number(v).toLocaleString(undefined, {maximumFractionDigits: 2});
}

function daysLabel(days) {
  if (days < 1) return Math.max(1, Math.round(days * 24)) + '小时';
  return Math.ceil(days) + '天';
}

function fmtVolume(v) {
  if (v >= 1000) return (v / 1000).toFixed(1) + 'K';
  if (v >= 1) return v.toFixed(1);
  return v.toFixed(3);
}

// ── Status ──────────────────────────────────────────────────────────────────
function setStatus(type, msg) {
  const bar = $('#statusBar');
  bar.className = 'status-bar ' + type;
  $('#statusText').textContent = msg;
}

// ── Position Management (shared with index.html via localStorage) ────────────

function getPositions() {
  try { return JSON.parse(localStorage.getItem('positions') || '[]'); }
  catch(_) { return []; }
}

function savePositions(positions) {
  localStorage.setItem('positions', JSON.stringify(positions));
}

function parseExpiryFromSymbol(symbol) {
  const parts = symbol.split('-');
  if (parts.length < 3) return null;
  const dateStr = parts[1];
  if (dateStr.length !== 6) return null;
  const yy = dateStr.substring(0, 2);
  const mm = dateStr.substring(2, 4);
  const dd = dateStr.substring(4, 6);
  return new Date(2000 + parseInt(yy), parseInt(mm) - 1, parseInt(dd));
}

function parseCoinFromSymbol(symbol) {
  return symbol.split('-')[0] || '';
}

async function loadMissingTickers() {
  const positions = getPositions();
  const neededCoins = new Set();
  positions.forEach(p => {
    const coin = parseCoinFromSymbol(p.symbol);
    if (coin && !allTickers[p.symbol]) neededCoins.add(coin);
  });
  for (const coin of neededCoins) {
    try {
      const res = await fetch(`/api/options-tickers?coin=${coin}`);
      const j = await res.json();
      if (j.ok && j.tickers) Object.assign(allTickers, j.tickers);
    } catch(_) {}
  }
}

function openPositionModal(symbol, bidPrice) {
  $('#posSymbol').value = symbol || '';
  $('#posSellPrice').value = bidPrice ? Number(bidPrice).toFixed(2) : '';
  $('#posQty').value = '';
  $('#posDate').value = new Date().toISOString().split('T')[0];
  $('#posModal').classList.remove('hidden');
  if (!symbol) $('#posSymbol').focus();
  else $('#posQty').focus();
}

function closeModal() {
  $('#posModal').classList.add('hidden');
}

function savePosition() {
  const symbol = $('#posSymbol').value.trim().toUpperCase();
  const sellPrice = parseFloat($('#posSellPrice').value);
  const qty = parseFloat($('#posQty').value);
  const date = $('#posDate').value;

  if (!symbol) return alert('请输入期权合约');
  if (!sellPrice || sellPrice <= 0) return alert('请输入有效的卖出价格');
  if (!qty || qty <= 0) return alert('请输入有效的数量');
  if (!date) return alert('请选择建仓日期');

  const positions = getPositions();
  positions.push({
    id: Date.now().toString(),
    symbol,
    sellPrice,
    qty,
    openDate: date,
  });
  savePositions(positions);
  closeModal();
  renderPositions();
}

function deletePosition(id) {
  if (!confirm('确定删除此持仓记录？')) return;
  const positions = getPositions().filter(p => p.id !== id);
  savePositions(positions);
  renderPositions();
}

function renderPositions() {
  const positions = getPositions();
  const countEl = $('#posCount');
  const contentEl = $('#posContent');
  countEl.textContent = positions.length;

  if (positions.length === 0) {
    contentEl.innerHTML = '<div class="pos-empty">暂无持仓，可在上方表格中点击「建仓」添加</div>';
    return;
  }

  const now = new Date();
  const rows = positions.map(p => {
    const ticker = allTickers[p.symbol];
    const askPrice = ticker ? parseFloat(ticker.askPrice) : null;
    const expiry = parseExpiryFromSymbol(p.symbol);
    const openDate = new Date(p.openDate);

    const daysLeft = expiry ? Math.max(0, Math.ceil((expiry - now) / 86400000)) : null;
    const daysHeld = Math.max(1, Math.ceil((now - openDate) / 86400000));

    let earnedPct = null, earnedUsd = null, holdApr = null, closeApr = null, signal = '';

    if (askPrice !== null) {
      earnedPct = (p.sellPrice - askPrice) / p.sellPrice * 100;
      earnedUsd = (p.sellPrice - askPrice) * p.qty;

      if (daysLeft !== null && daysLeft > 0) {
        holdApr = (askPrice / p.sellPrice) * (365 / daysLeft) * 100;
      }

      if (daysHeld > 0) {
        closeApr = (earnedPct / 100) * (365 / daysHeld) * 100;
      }

      if (earnedPct < 0) {
        signal = '<span class="signal watch">观察</span>';
      } else if (earnedPct >= 80) {
        signal = '<span class="signal strong-close">强烈建议平仓</span>';
      } else if (earnedPct >= 50 && daysLeft !== null && daysLeft >= 10) {
        signal = '<span class="signal suggest-close">建议平仓再开</span>';
      } else if (closeApr !== null && holdApr !== null && closeApr > holdApr && earnedPct > 0) {
        signal = '<span class="signal suggest-close">平仓更优</span>';
      } else if (daysLeft !== null && daysLeft <= 2 && earnedPct > 0) {
        signal = '<span class="signal hold">持有到期</span>';
      } else {
        signal = '<span class="signal watch">观察</span>';
      }
    }

    return { ...p, askPrice, expiry, daysLeft, daysHeld, earnedPct, earnedUsd, holdApr, closeApr, signal };
  });

  const fmtPct = v => v !== null ? v.toFixed(1) + '%' : '—';
  const fmtUsd = v => v !== null ? (v >= 0 ? '+' : '') + '$' + v.toFixed(2) : '—';
  const pctColor = v => v === null ? 'var(--text2)' : v >= 0 ? 'var(--green)' : 'var(--red)';
  const aprFmt = v => v !== null ? v.toFixed(1) + '%' : '—';

  contentEl.innerHTML = `
    <div style="overflow-x:auto">
    <table class="pos-table">
      <thead><tr>
        <th>合约</th><th>卖出价</th><th>数量</th><th>当前Ask</th>
        <th>已赚%</th><th>已赚$</th><th>剩余天数</th>
        <th>持有年化</th><th>平仓年化</th><th>信号</th><th>操作</th>
      </tr></thead>
      <tbody>${rows.map(r => `<tr>
        <td style="font-size:.7rem">${r.symbol}</td>
        <td>${r.sellPrice.toFixed(2)}</td>
        <td>${r.qty}</td>
        <td>${r.askPrice !== null ? r.askPrice.toFixed(2) : '<span style="color:var(--text2)">—</span>'}</td>
        <td style="color:${pctColor(r.earnedPct)}">${fmtPct(r.earnedPct)}</td>
        <td style="color:${pctColor(r.earnedUsd)}">${fmtUsd(r.earnedUsd)}</td>
        <td>${r.daysLeft !== null ? r.daysLeft + '天' : '—'}</td>
        <td>${aprFmt(r.holdApr)}</td>
        <td>${aprFmt(r.closeApr)}</td>
        <td>${r.signal}</td>
        <td><button class="btn-sm danger" onclick="deletePosition('${r.id}')">删除</button></td>
      </tr>`).join('')}</tbody>
    </table>
    </div>
    <div style="margin-top:12px;text-align:right">
      <button class="btn-sm" onclick="openPositionModal('','')">+ 手动添加</button>
    </div>
  `;
}

// 页面加载时渲染持仓
renderPositions();

// 点击弹窗外部关闭
$('#posModal').addEventListener('click', function(e) {
  if (e.target === this) closeModal();
});
</script>
</body>
</html>
