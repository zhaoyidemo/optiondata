<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å¸å®‰æœŸæƒè¡Œæƒ… â€” BTC / ETH</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#0f1117;--surface:#1a1d27;--border:#2a2d3a;
  --text:#e2e8f0;--text2:#94a3b8;
  --green:#4ade80;--red:#f87171;--yellow:#fbbf24;--purple:#818cf8;
  --blue:#60a5fa;
}
body{
  font-family:'JetBrains Mono',monospace;background:var(--bg);color:var(--text);
  min-height:100vh;padding:0 20px 20px;
}
a{color:var(--purple)}

/* nav bar */
.nav-bar{
  display:flex;align-items:center;gap:0;
  padding:12px 0;margin-bottom:16px;border-bottom:1px solid var(--border);
}
.nav-link{
  padding:8px 20px;font-size:.8rem;color:var(--text2);
  text-decoration:none;border-radius:6px 6px 0 0;
  border:1px solid transparent;border-bottom:none;
  transition:all .15s;font-family:inherit;
  position:relative;top:1px;
}
.nav-link:hover{color:var(--text)}
.nav-link.active{
  color:var(--green);background:var(--surface);
  border-color:var(--border);
}

/* header */
.header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap;gap:12px}
.header h1{font-size:1.2rem;color:var(--green)}
.header .spot{font-size:.95rem;color:var(--text2)}
.header .spot b{color:var(--yellow);font-weight:600}

/* status bar */
.status-bar{
  padding:10px 16px;border-radius:8px;margin-bottom:16px;font-size:.8rem;
  display:flex;align-items:center;gap:8px;
}
.status-bar.ok{background:#16a34a22;border:1px solid #16a34a44;color:var(--green)}
.status-bar.err{background:#dc262622;border:1px solid #dc262644;color:var(--red)}
.status-bar.loading{background:#2563eb22;border:1px solid #2563eb44;color:var(--blue)}
.dot{width:8px;height:8px;border-radius:50%;display:inline-block}
.status-bar.ok .dot{background:var(--green)}
.status-bar.err .dot{background:var(--red)}
.status-bar.loading .dot{background:var(--blue);animation:pulse 1s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}

/* filters */
.filters{
  display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:20px;
}
.filters label{font-size:.75rem;color:var(--text2);margin-right:2px}
.pill-group{display:flex;gap:4px}
.pill{
  padding:6px 14px;border-radius:6px;font-size:.75rem;cursor:pointer;
  border:1px solid var(--border);background:transparent;color:var(--text2);
  font-family:inherit;transition:all .15s;
}
.pill:hover{border-color:var(--purple)}
.pill.active{background:var(--purple);color:#fff;border-color:var(--purple)}
.btn{
  padding:6px 14px;border-radius:6px;font-size:.75rem;cursor:pointer;
  border:1px solid var(--border);background:var(--surface);color:var(--text);
  font-family:inherit;transition:all .15s;
}
.btn:hover{border-color:var(--green);color:var(--green)}
.btn.active{background:var(--green);color:var(--bg);border-color:var(--green)}
.spacer{flex:1}

/* stat cards */
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin-bottom:24px}
.stat-card{
  background:var(--surface);border:1px solid var(--border);border-radius:10px;
  padding:16px 20px;
}
.stat-card .label{font-size:.7rem;color:var(--text2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px}
.stat-card .value{font-size:1.4rem;font-weight:700}
.stat-card .value.green{color:var(--green)}
.stat-card .value.yellow{color:var(--yellow)}
.stat-card .value.purple{color:var(--purple)}
.stat-card .value.blue{color:var(--blue)}

/* table */
.table-wrap{
  background:var(--surface);border:1px solid var(--border);border-radius:10px;
  overflow-x:auto;margin-bottom:24px;
}
table{width:100%;border-collapse:collapse;font-size:.78rem}
th{
  padding:12px 10px;text-align:left;color:var(--text2);font-weight:500;
  border-bottom:1px solid var(--border);cursor:pointer;white-space:nowrap;
  user-select:none;
}
th:hover{color:var(--purple)}
th .arrow{font-size:.65rem;margin-left:3px}
td{padding:10px;border-bottom:1px solid var(--border);white-space:nowrap}
tr:hover{background:#ffffff06}
.tag{
  display:inline-block;padding:2px 8px;border-radius:4px;font-size:.7rem;font-weight:600;
}
.tag.call{background:#818cf822;color:var(--purple)}
.tag.put{background:#60a5fa22;color:var(--blue)}
.tag.otm{background:#4ade8022;color:var(--green)}
.tag.itm{background:#f8717122;color:var(--red)}
.tag.atm{background:#fbbf2422;color:var(--yellow)}

.note{font-size:.7rem;color:var(--text2);text-align:center;padding:20px}

/* position panel */
.pos-section{
  background:var(--surface);border:1px solid var(--border);border-radius:10px;
  margin-bottom:24px;padding:20px;
}
.pos-section h2{font-size:.95rem;color:var(--yellow);margin-bottom:16px;display:flex;align-items:center;gap:8px}
.pos-section h2 .pos-count{
  font-size:.7rem;background:var(--yellow);color:var(--bg);
  padding:2px 8px;border-radius:10px;font-weight:700;
}
.pos-empty{color:var(--text2);font-size:.8rem;padding:20px 0;text-align:center}
.pos-table{width:100%;border-collapse:collapse;font-size:.75rem}
.pos-table th{
  padding:10px 8px;text-align:left;color:var(--text2);font-weight:500;
  border-bottom:1px solid var(--border);white-space:nowrap;font-size:.7rem;
}
.pos-table td{padding:8px;border-bottom:1px solid var(--border);white-space:nowrap}
.pos-table tr:hover{background:#ffffff06}
.signal{display:inline-block;padding:2px 8px;border-radius:4px;font-size:.68rem;font-weight:600}
.signal.strong-close{background:#f8717133;color:var(--red)}
.signal.suggest-close{background:#fbbf2433;color:var(--yellow)}
.signal.hold{background:#4ade8033;color:var(--green)}
.signal.watch{background:#64748b33;color:#94a3b8}
.btn-sm{
  padding:3px 10px;border-radius:4px;font-size:.68rem;cursor:pointer;
  border:1px solid var(--border);background:transparent;color:var(--text2);
  font-family:inherit;transition:all .15s;
}
.btn-sm:hover{border-color:var(--purple);color:var(--purple)}
.btn-sm.danger:hover{border-color:var(--red);color:var(--red)}
.btn-open{
  padding:2px 8px;border-radius:4px;font-size:.66rem;cursor:pointer;
  border:1px solid var(--green);background:transparent;color:var(--green);
  font-family:inherit;transition:all .15s;
}
.btn-open:hover{background:var(--green);color:var(--bg)}

/* modal */
.modal-overlay{
  position:fixed;top:0;left:0;width:100%;height:100%;
  background:rgba(0,0,0,.6);z-index:1000;display:flex;align-items:center;justify-content:center;
}
.modal-overlay.hidden{display:none}
.modal{
  background:var(--surface);border:1px solid var(--border);border-radius:12px;
  padding:24px;width:420px;max-width:95vw;
}
.modal h3{font-size:.9rem;color:var(--green);margin-bottom:16px}
.modal .form-row{margin-bottom:12px}
.modal .form-row label{display:block;font-size:.7rem;color:var(--text2);margin-bottom:4px}
.modal .form-row input{
  width:100%;padding:8px 12px;border-radius:6px;border:1px solid var(--border);
  background:var(--bg);color:var(--text);font-family:inherit;font-size:.8rem;
}
.modal .form-row input:focus{outline:none;border-color:var(--purple)}
.modal .form-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:16px}
.modal .form-actions button{
  padding:8px 20px;border-radius:6px;font-size:.78rem;cursor:pointer;
  font-family:inherit;border:none;transition:all .15s;
}
.modal .btn-cancel{background:var(--border);color:var(--text)}
.modal .btn-cancel:hover{background:#3a3d4a}
.modal .btn-submit{background:var(--green);color:var(--bg);font-weight:600}
.modal .btn-submit:hover{opacity:.85}
</style>
</head>
<body>

<!-- Navigation -->
<nav class="nav-bar">
  <a class="nav-link" href="/">åŒå¸å¯¹æ¯”</a>
  <a class="nav-link active" href="/options">æœŸæƒè¡Œæƒ…</a>
  <a class="nav-link" href="/deribit">Deribitå¯¹æ¯”</a>
</nav>

<div class="header">
  <h1>å¸å®‰æœŸæƒè¡Œæƒ…</h1>
  <div class="spot">
    <span id="coinLabel">ETH</span>/USDT ç°è´§: <b id="spotPrice">â€”</b>
    &nbsp;Â·&nbsp; <span id="updateTime">â€”</span>
  </div>
</div>

<div id="statusBar" class="status-bar loading">
  <span class="dot"></span> <span id="statusText">æ­£åœ¨åŠ è½½â€¦</span>
</div>

<!-- Filters -->
<div class="filters">
  <label>å¸ç§</label>
  <div class="pill-group" id="coinGroup">
    <button class="pill active" data-coin="ETH">ETH</button>
    <button class="pill" data-coin="BTC">BTC</button>
  </div>
  <label>ç±»å‹</label>
  <div class="pill-group" id="typeGroup">
    <button class="pill active" data-type="ALL">å…¨éƒ¨</button>
    <button class="pill" data-type="CALL">CALL</button>
    <button class="pill" data-type="PUT">PUT</button>
  </div>
  <label>æœŸé™</label>
  <div class="pill-group" id="termGroup">
    <button class="pill active" data-min="0" data-max="0">å…¨éƒ¨</button>
    <button class="pill" data-min="0" data-max="3">0-3å¤©</button>
    <button class="pill" data-min="3" data-max="7">3-7å¤©</button>
    <button class="pill" data-min="7" data-max="14">7-14å¤©</button>
    <button class="pill" data-min="14" data-max="30">14-30å¤©</button>
    <button class="pill" data-min="30" data-max="90">30-90å¤©</button>
    <button class="pill" data-min="90" data-max="9999">90å¤©+</button>
  </div>
  <label>ä»·å€¼</label>
  <div class="pill-group" id="moneynessGroup">
    <button class="pill active" data-mn="ALL">å…¨éƒ¨</button>
    <button class="pill" data-mn="OTM">è™šå€¼</button>
    <button class="pill" data-mn="ITM">å®å€¼</button>
  </div>
  <div class="spacer"></div>
  <button class="btn" id="btnRefresh">âŸ³ åˆ·æ–°</button>
  <button class="btn" id="btnAuto">è‡ªåŠ¨ OFF</button>
</div>

<!-- Stats -->
<div class="stats">
  <div class="stat-card"><div class="label">åˆçº¦æ€»æ•°</div><div class="value purple" id="statTotal">â€”</div></div>
  <div class="stat-card"><div class="label">CALL åˆçº¦</div><div class="value purple" id="statCalls">â€”</div></div>
  <div class="stat-card"><div class="label">PUT åˆçº¦</div><div class="value blue" id="statPuts">â€”</div></div>
  <div class="stat-card"><div class="label">æœ€è¿‘åˆ°æœŸ</div><div class="value yellow" id="statNearest">â€”</div></div>
  <div class="stat-card"><div class="label">ç°è´§ä»·æ ¼</div><div class="value green" id="statSpot">â€”</div></div>
</div>

<!-- Data Table -->
<div class="table-wrap">
  <table id="optionsTable">
    <thead>
      <tr>
        <th data-key="type">ç±»å‹ <span class="arrow"></span></th>
        <th data-key="strike">è¡Œæƒä»· <span class="arrow"></span></th>
        <th data-key="expiryStr">åˆ°æœŸæ—¥ <span class="arrow"></span></th>
        <th data-key="daysLeft">å¤©æ•° <span class="arrow"></span></th>
        <th data-key="moneyness">è·ç¦»% <span class="arrow"></span></th>
        <th data-key="bid">Bid <span class="arrow"></span></th>
        <th data-key="ask">Ask <span class="arrow"></span></th>
        <th data-key="lastPrice">æœ€æ–°ä»· <span class="arrow"></span></th>
        <th data-key="volume">24hé‡ <span class="arrow"></span></th>
        <th data-key="breakeven">ç›ˆäºå¹³è¡¡ <span class="arrow"></span></th>
        <th data-key="aprNet">å–å‡ºAPR <span class="arrow"></span></th>
        <th>æ“ä½œ</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>
</div>

<!-- Position Panel -->
<div class="pos-section" id="posSection">
  <h2>ğŸ“Š æˆ‘çš„æŒä»“ <span class="pos-count" id="posCount">0</span></h2>
  <div id="posContent">
    <div class="pos-empty">æš‚æ— æŒä»“ï¼Œå¯åœ¨ä¸Šæ–¹è¡¨æ ¼ä¸­ç‚¹å‡»ã€Œå»ºä»“ã€æ·»åŠ </div>
  </div>
</div>

<!-- Position Modal -->
<div class="modal-overlay hidden" id="posModal">
  <div class="modal">
    <h3>æ–°å»ºæŒä»“</h3>
    <div class="form-row">
      <label>æœŸæƒåˆçº¦</label>
      <input type="text" id="posSymbol" placeholder="å¦‚ ETH-260327-2000-P">
    </div>
    <div class="form-row">
      <label>å–å‡ºä»·æ ¼ï¼ˆæƒåˆ©é‡‘ï¼‰</label>
      <input type="number" id="posSellPrice" step="any" placeholder="å¦‚ 50.5">
    </div>
    <div class="form-row">
      <label>æ•°é‡ï¼ˆå¸æ•°ï¼‰</label>
      <input type="number" id="posQty" step="any" placeholder="å¦‚ 1">
    </div>
    <div class="form-row">
      <label>å»ºä»“æ—¥æœŸ</label>
      <input type="date" id="posDate">
    </div>
    <div class="form-actions">
      <button class="btn-cancel" onclick="closeModal()">å–æ¶ˆ</button>
      <button class="btn-submit" onclick="savePosition()">ç¡®è®¤å»ºä»“</button>
    </div>
  </div>
</div>

<div class="note">
  * æœŸæƒäº¤æ˜“æ‰‹ç»­è´¹å·²æŒ‰ 0.024%ï¼ˆåä¹‰ä»·å€¼ï¼‰è®¡å…¥ APRï¼›è¡Œæƒè´¹ 0.015% ä»…å®å€¼åˆ°æœŸæ—¶æ”¶å–ï¼Œæœªè®¡å…¥<br>
  * ç›ˆäºå¹³è¡¡ä»·åŸºäº Bid ä»·è®¡ç®—ï¼šPUT = è¡Œæƒä»· - Bidï¼ŒCALL = è¡Œæƒä»· + Bid<br>
  * æ•°æ®æ¥æº: å¸å®‰æ¬§å¼æœŸæƒ API (EAPI)
</div>

<script>
// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let currentCoin = 'ETH';
let filterType = 'ALL';
let filterDaysMin = 0;
let filterDaysMax = 0;
let filterMoneyness = 'ALL';
let sortKey = 'aprNet';
let sortAsc = false;
let autoRefresh = false;
let autoTimer = null;
let rawRows = [];
let spotPrice = 0;
let allTickers = {};

// â”€â”€ DOM refs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const $ = (s) => document.querySelector(s);
const $$ = (s) => document.querySelectorAll(s);

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
loadData();

// â”€â”€ Coin pills â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
$('#coinGroup').addEventListener('click', (e) => {
  const btn = e.target.closest('.pill');
  if (!btn) return;
  $$('#coinGroup .pill').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  currentCoin = btn.dataset.coin;
  loadData();
});

// â”€â”€ Type pills â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
$('#typeGroup').addEventListener('click', (e) => {
  const btn = e.target.closest('.pill');
  if (!btn) return;
  $$('#typeGroup .pill').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  filterType = btn.dataset.type;
  render();
});

// â”€â”€ Term pills â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
$('#termGroup').addEventListener('click', (e) => {
  const btn = e.target.closest('.pill');
  if (!btn) return;
  $$('#termGroup .pill').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  filterDaysMin = parseInt(btn.dataset.min);
  filterDaysMax = parseInt(btn.dataset.max);
  render();
});

// â”€â”€ Moneyness pills â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
$('#moneynessGroup').addEventListener('click', (e) => {
  const btn = e.target.closest('.pill');
  if (!btn) return;
  $$('#moneynessGroup .pill').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  filterMoneyness = btn.dataset.mn;
  render();
});

// â”€â”€ Refresh â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
$('#btnRefresh').addEventListener('click', () => loadData());

$('#btnAuto').addEventListener('click', () => {
  autoRefresh = !autoRefresh;
  $('#btnAuto').textContent = autoRefresh ? 'è‡ªåŠ¨ ON' : 'è‡ªåŠ¨ OFF';
  $('#btnAuto').classList.toggle('active', autoRefresh);
  if (autoRefresh) {
    autoTimer = setInterval(() => loadData(), 60000);
  } else {
    clearInterval(autoTimer);
  }
});

// â”€â”€ Table sort â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
$$('#optionsTable th').forEach(th => {
  th.addEventListener('click', () => {
    const key = th.dataset.key;
    if (!key) return;
    if (sortKey === key) {
      sortAsc = !sortAsc;
    } else {
      sortKey = key;
      sortAsc = key === 'type' || key === 'expiryStr';
    }
    render();
  });
});

// â”€â”€ Data loading â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadData() {
  setStatus('loading', `æ­£åœ¨åŠ è½½ ${currentCoin} æœŸæƒæ•°æ®â€¦`);
  try {
    const [tickerRes, spotRes] = await Promise.all([
      fetch(`/api/options-tickers?coin=${currentCoin}`),
      fetch(`/api/spot-price?coin=${currentCoin}`)
    ]);
    const tj = await tickerRes.json();
    const sj = await spotRes.json();
    if (!tj.ok) throw new Error(tj.error || 'Ticker error');
    if (!sj.ok) throw new Error(sj.error || 'Spot error');

    spotPrice = sj.price;
    const tickers = tj.tickers;
    Object.assign(allTickers, tickers);

    rawRows = [];
    for (const [symbol, ticker] of Object.entries(tickers)) {
      const parsed = parseOptionSymbol(symbol);
      if (!parsed) continue;
      const calc = calcRow(ticker, parsed);
      rawRows.push({ symbol, ...parsed, ...calc });
    }

    await loadMissingTickers();

    const now = new Date();
    $('#updateTime').textContent = now.toISOString().replace('T', ' ').substring(0, 19) + ' UTC';
    setStatus('ok', `${currentCoin} æœŸæƒæ•°æ®åŠ è½½å®Œæˆ Â· ${rawRows.length} ä¸ªåˆçº¦`);
    render();
    renderPositions();
  } catch (e) {
    setStatus('err', 'åŠ è½½å¤±è´¥: ' + e.message);
  }
}

// â”€â”€ Symbol parser â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function parseOptionSymbol(symbol) {
  const parts = symbol.split('-');
  if (parts.length !== 4) return null;
  const coin = parts[0];
  const dateStr = parts[1];
  if (dateStr.length !== 6) return null;
  const strike = parseFloat(parts[2]);
  const typeCode = parts[3];
  const type = typeCode === 'C' ? 'CALL' : 'PUT';

  const yy = parseInt(dateStr.substring(0, 2));
  const mm = parseInt(dateStr.substring(2, 4));
  const dd = parseInt(dateStr.substring(4, 6));
  const expiry = new Date(Date.UTC(2000 + yy, mm - 1, dd, 8, 0, 0));
  const now = new Date();
  const daysLeft = Math.max(0, (expiry - now) / 86400000);

  return {
    coin,
    strike,
    type,
    typeCode,
    expiry,
    expiryStr: `${2000 + yy}-${String(mm).padStart(2, '0')}-${String(dd).padStart(2, '0')}`,
    daysLeft: Math.round(daysLeft * 100) / 100,
    daysLabel: daysLeft < 1 ? Math.max(1, Math.floor(daysLeft * 24)) + 'å°æ—¶' : Math.ceil(daysLeft) + 'å¤©',
  };
}

// â”€â”€ Row calculations â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function calcRow(ticker, parsed) {
  const bid = parseFloat(ticker.bidPrice) || 0;
  const ask = parseFloat(ticker.askPrice) || 0;
  const lastPrice = parseFloat(ticker.lastPrice) || 0;
  const volume = parseFloat(ticker.volume) || 0;
  const days = Math.max(0.01, parsed.daysLeft);

  const fee = spotPrice * 0.00024;
  const netBid = Math.max(0, bid - fee);

  let aprNet = 0;
  if (parsed.type === 'PUT' && parsed.strike > 0) {
    aprNet = (netBid / parsed.strike) * (365 / days);
  } else if (spotPrice > 0) {
    aprNet = (netBid / spotPrice) * (365 / days);
  }

  // è·ç¦»%ï¼šæ­£=è™šå€¼OTMï¼Œè´Ÿ=å®å€¼ITM
  let moneyness = 0;
  if (parsed.type === 'CALL' && spotPrice > 0) {
    moneyness = (parsed.strike - spotPrice) / spotPrice * 100;
  } else if (parsed.type === 'PUT' && spotPrice > 0) {
    moneyness = (spotPrice - parsed.strike) / spotPrice * 100;
  }
  const moneynessLabel = moneyness > 0.5 ? 'OTM' : moneyness < -0.5 ? 'ITM' : 'ATM';

  // ç›ˆäºå¹³è¡¡ä»·ï¼šå–PUT = strike - bidï¼Œå–CALL = strike + bid
  const breakeven = parsed.type === 'PUT' ? parsed.strike - bid : parsed.strike + bid;
  let breakevenPct = 0;
  if (spotPrice > 0) {
    breakevenPct = (breakeven - spotPrice) / spotPrice * 100;
  }

  return {
    bid, ask, lastPrice, volume,
    aprNet: Math.max(0, aprNet),
    moneyness: Math.round(moneyness * 100) / 100,
    moneynessLabel,
    breakeven,
    breakevenPct: Math.round(breakevenPct * 100) / 100,
  };
}

// â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function render() {
  if (!rawRows.length && !spotPrice) return;

  $('#coinLabel').textContent = currentCoin;
  $('#spotPrice').textContent = '$' + Number(spotPrice).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

  // filter
  let rows = rawRows.slice();
  if (filterType !== 'ALL') rows = rows.filter(r => r.type === filterType);
  if (filterDaysMax > 0) rows = rows.filter(r => r.daysLeft >= filterDaysMin && r.daysLeft <= filterDaysMax);
  if (filterMoneyness === 'OTM') rows = rows.filter(r => r.moneyness > 0.5);
  else if (filterMoneyness === 'ITM') rows = rows.filter(r => r.moneyness < -0.5);

  // sort
  rows.sort((a, b) => {
    let va = a[sortKey], vb = b[sortKey];
    if (typeof va === 'string') { va = va.toLowerCase(); vb = vb.toLowerCase(); }
    if (va < vb) return sortAsc ? -1 : 1;
    if (va > vb) return sortAsc ? 1 : -1;
    return 0;
  });

  // stats
  const calls = rows.filter(r => r.type === 'CALL').length;
  const puts = rows.filter(r => r.type === 'PUT').length;
  const nearest = rows.length ? Math.min(...rows.map(r => r.daysLeft)) : null;
  $('#statTotal').textContent = rows.length;
  $('#statCalls').textContent = calls;
  $('#statPuts').textContent = puts;
  $('#statNearest').textContent = nearest !== null
    ? (nearest < 1 ? Math.max(1, Math.floor(nearest * 24)) + 'å°æ—¶' : Math.ceil(nearest) + 'å¤©')
    : 'â€”';
  $('#statSpot').textContent = '$' + Number(spotPrice).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

  // sort arrows
  $$('#optionsTable th').forEach(th => {
    const arrow = th.querySelector('.arrow');
    if (!arrow) return;
    arrow.textContent = th.dataset.key === sortKey ? (sortAsc ? 'â–²' : 'â–¼') : '';
  });

  // table
  const tbody = $('#tableBody');
  tbody.innerHTML = rows.map(r => {
    const mnClass = r.moneynessLabel.toLowerCase();
    const mnSign = r.moneyness >= 0 ? '+' : '';
    // PUTç›ˆäºå¹³è¡¡ä½äºç°è´§=å®‰å…¨(ç»¿)ï¼ŒCALLç›ˆäºå¹³è¡¡é«˜äºç°è´§=å®‰å…¨(ç»¿)
    const beColor = r.type === 'PUT'
      ? (r.breakevenPct < 0 ? 'var(--green)' : 'var(--red)')
      : (r.breakevenPct > 0 ? 'var(--green)' : 'var(--red)');
    const beSign = r.breakevenPct >= 0 ? '+' : '';
    return `<tr>
    <td><span class="tag ${r.type.toLowerCase()}">${r.type}</span></td>
    <td>${fmtStrike(r.strike)}</td>
    <td>${r.expiryStr}</td>
    <td>${r.daysLabel}</td>
    <td><span class="tag ${mnClass}">${mnSign}${r.moneyness.toFixed(1)}%</span></td>
    <td>${r.bid ? r.bid.toFixed(2) : 'â€”'}</td>
    <td>${r.ask ? r.ask.toFixed(2) : 'â€”'}</td>
    <td>${r.lastPrice ? r.lastPrice.toFixed(2) : 'â€”'}</td>
    <td>${r.volume ? r.volume.toFixed(1) : 'â€”'}</td>
    <td style="color:${beColor}">${fmtStrike(r.breakeven)} <span style="font-size:.65rem;opacity:.7">(${beSign}${r.breakevenPct.toFixed(1)}%)</span></td>
    <td style="color:var(--green)">${r.aprNet > 0 ? (r.aprNet * 100).toFixed(1) + '%' : 'â€”'}</td>
    <td>${r.bid > 0 ? `<button class="btn-open" onclick="openPositionModal('${r.symbol}', ${r.bid})">å»ºä»“</button>` : ''}</td>
  </tr>`;
  }).join('');
}

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fmtStrike(v) {
  const n = Number(v);
  return n === Math.floor(n) ? n.toLocaleString() : n.toLocaleString(undefined, { maximumFractionDigits: 2 });
}

function setStatus(type, msg) {
  $('#statusBar').className = 'status-bar ' + type;
  $('#statusText').textContent = msg;
}

// â”€â”€ Position Management (å…±äº« localStorage) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function getPositions() {
  try { return JSON.parse(localStorage.getItem('positions') || '[]'); }
  catch(_) { return []; }
}

function savePositions(positions) {
  localStorage.setItem('positions', JSON.stringify(positions));
}

function parseExpiryFromSymbol(symbol) {
  const parts = symbol.split('-');
  if (parts.length < 3) return null;
  const dateStr = parts[1];
  if (dateStr.length !== 6) return null;
  return new Date(2000 + parseInt(dateStr.substring(0, 2)), parseInt(dateStr.substring(2, 4)) - 1, parseInt(dateStr.substring(4, 6)));
}

function parseCoinFromSymbol(symbol) {
  return symbol.split('-')[0] || '';
}

async function loadMissingTickers() {
  const positions = getPositions();
  const neededCoins = new Set();
  positions.forEach(p => {
    const coin = parseCoinFromSymbol(p.symbol);
    if (coin && !allTickers[p.symbol]) neededCoins.add(coin);
  });
  for (const coin of neededCoins) {
    try {
      const res = await fetch(`/api/options-tickers?coin=${coin}`);
      const j = await res.json();
      if (j.ok && j.tickers) Object.assign(allTickers, j.tickers);
    } catch(_) {}
  }
}

function openPositionModal(symbol, bidPrice) {
  $('#posSymbol').value = symbol || '';
  $('#posSellPrice').value = bidPrice ? Number(bidPrice).toFixed(2) : '';
  $('#posQty').value = '';
  $('#posDate').value = new Date().toISOString().split('T')[0];
  $('#posModal').classList.remove('hidden');
  if (!symbol) $('#posSymbol').focus();
  else $('#posQty').focus();
}

function closeModal() {
  $('#posModal').classList.add('hidden');
}

function savePosition() {
  const symbol = $('#posSymbol').value.trim().toUpperCase();
  const sellPrice = parseFloat($('#posSellPrice').value);
  const qty = parseFloat($('#posQty').value);
  const date = $('#posDate').value;

  if (!symbol) return alert('è¯·è¾“å…¥æœŸæƒåˆçº¦');
  if (!sellPrice || sellPrice <= 0) return alert('è¯·è¾“å…¥æœ‰æ•ˆçš„å–å‡ºä»·æ ¼');
  if (!qty || qty <= 0) return alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°é‡');
  if (!date) return alert('è¯·é€‰æ‹©å»ºä»“æ—¥æœŸ');

  const positions = getPositions();
  positions.push({ id: Date.now().toString(), symbol, sellPrice, qty, openDate: date });
  savePositions(positions);
  closeModal();
  renderPositions();
}

function deletePosition(id) {
  if (!confirm('ç¡®å®šåˆ é™¤æ­¤æŒä»“è®°å½•ï¼Ÿ')) return;
  savePositions(getPositions().filter(p => p.id !== id));
  renderPositions();
}

function renderPositions() {
  const positions = getPositions();
  $('#posCount').textContent = positions.length;
  const contentEl = $('#posContent');

  if (positions.length === 0) {
    contentEl.innerHTML = '<div class="pos-empty">æš‚æ— æŒä»“ï¼Œå¯åœ¨ä¸Šæ–¹è¡¨æ ¼ä¸­ç‚¹å‡»ã€Œå»ºä»“ã€æ·»åŠ </div>';
    return;
  }

  const now = new Date();
  const rows = positions.map(p => {
    const ticker = allTickers[p.symbol];
    const askPrice = ticker ? parseFloat(ticker.askPrice) : null;
    const expiry = parseExpiryFromSymbol(p.symbol);
    const openDate = new Date(p.openDate);
    const daysLeft = expiry ? Math.max(0, Math.ceil((expiry - now) / 86400000)) : null;
    const daysHeld = Math.max(1, Math.ceil((now - openDate) / 86400000));

    let earnedPct = null, earnedUsd = null, holdApr = null, closeApr = null, signal = '';
    if (askPrice !== null) {
      earnedPct = (p.sellPrice - askPrice) / p.sellPrice * 100;
      earnedUsd = (p.sellPrice - askPrice) * p.qty;
      if (daysLeft !== null && daysLeft > 0)
        holdApr = (askPrice / p.sellPrice) * (365 / daysLeft) * 100;
      if (daysHeld > 0)
        closeApr = (earnedPct / 100) * (365 / daysHeld) * 100;

      if (earnedPct < 0)
        signal = '<span class="signal watch">âšª è§‚å¯Ÿ</span>';
      else if (earnedPct >= 80)
        signal = '<span class="signal strong-close">ğŸ”´ å¼ºçƒˆå»ºè®®å¹³ä»“</span>';
      else if (earnedPct >= 50 && daysLeft !== null && daysLeft >= 10)
        signal = '<span class="signal suggest-close">ğŸŸ¡ å»ºè®®å¹³ä»“å†å¼€</span>';
      else if (closeApr !== null && holdApr !== null && closeApr > holdApr && earnedPct > 0)
        signal = '<span class="signal suggest-close">ğŸŸ¡ å¹³ä»“æ›´ä¼˜</span>';
      else if (daysLeft !== null && daysLeft <= 2 && earnedPct > 0)
        signal = '<span class="signal hold">ğŸŸ¢ æŒæœ‰åˆ°æœŸ</span>';
      else
        signal = '<span class="signal watch">âšª è§‚å¯Ÿ</span>';
    }
    return { ...p, askPrice, daysLeft, daysHeld, earnedPct, earnedUsd, holdApr, closeApr, signal };
  });

  const fmtPct = v => v !== null ? v.toFixed(1) + '%' : 'â€”';
  const fmtUsd = v => v !== null ? (v >= 0 ? '+' : '') + '$' + v.toFixed(2) : 'â€”';
  const pctColor = v => v === null ? 'var(--text2)' : v >= 0 ? 'var(--green)' : 'var(--red)';
  const aprFmt = v => v !== null ? v.toFixed(1) + '%' : 'â€”';

  contentEl.innerHTML = `
    <div style="overflow-x:auto">
    <table class="pos-table">
      <thead><tr>
        <th>åˆçº¦</th><th>å–å‡ºä»·</th><th>æ•°é‡</th><th>å½“å‰Ask</th>
        <th>å·²èµš%</th><th>å·²èµš$</th><th>å‰©ä½™å¤©æ•°</th>
        <th>æŒæœ‰å¹´åŒ–</th><th>å¹³ä»“å¹´åŒ–</th><th>ä¿¡å·</th><th>æ“ä½œ</th>
      </tr></thead>
      <tbody>${rows.map(r => `<tr>
        <td style="font-size:.7rem">${r.symbol}</td>
        <td>${r.sellPrice.toFixed(2)}</td>
        <td>${r.qty}</td>
        <td>${r.askPrice !== null ? r.askPrice.toFixed(2) : '<span style="color:var(--text2)">â€”</span>'}</td>
        <td style="color:${pctColor(r.earnedPct)}">${fmtPct(r.earnedPct)}</td>
        <td style="color:${pctColor(r.earnedUsd)}">${fmtUsd(r.earnedUsd)}</td>
        <td>${r.daysLeft !== null ? r.daysLeft + 'å¤©' : 'â€”'}</td>
        <td>${aprFmt(r.holdApr)}</td>
        <td>${aprFmt(r.closeApr)}</td>
        <td>${r.signal}</td>
        <td><button class="btn-sm danger" onclick="deletePosition('${r.id}')">åˆ é™¤</button></td>
      </tr>`).join('')}</tbody>
    </table>
    </div>
    <div style="margin-top:12px;text-align:right">
      <button class="btn-sm" onclick="openPositionModal('','')">+ æ‰‹åŠ¨æ·»åŠ </button>
    </div>
  `;
}

renderPositions();

$('#posModal').addEventListener('click', function(e) {
  if (e.target === this) closeModal();
});
</script>
</body>
</html>
